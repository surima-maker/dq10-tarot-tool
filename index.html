<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DQ10 ã‚¿ãƒ­ãƒƒãƒˆãƒ‡ãƒƒã‚­ä¾¿åˆ©ãƒ„ãƒ¼ãƒ«</title>
<meta name="description" content="ãƒ‰ãƒ©ã‚´ãƒ³ã‚¯ã‚¨ã‚¹ãƒˆXï¼ˆDQ10ï¼‰ã®å ã„å¸«ç”¨ã‚¿ãƒ­ãƒƒãƒˆãƒ‡ãƒƒã‚­ã‚’æœ€é©åŒ–ã™ã‚‹ä¾¿åˆ©ãƒ„ãƒ¼ãƒ«ã€‚è¤‡æ•°ãƒ‡ãƒƒã‚­ã®ä¸€æ‹¬æœ€é©åŒ–ã€å¿…è¦ã‚«ãƒ¼ãƒ‰æšæ•°ã®æœ€å°åŒ–ã€ã‚ªãƒ¼ãƒ©ç™ºç”Ÿç‡ã‚’è€ƒæ…®ã—ãŸè‡ªå‹•æ§‹æˆãªã©ãŒå¯èƒ½ã§ã™ã€‚">
<meta property="og:title" content="DQ10 ã‚¿ãƒ­ãƒƒãƒˆãƒ‡ãƒƒã‚­ä¾¿åˆ©ãƒ„ãƒ¼ãƒ«">
<meta property="og:description" content="ãƒ‰ãƒ©ã‚´ãƒ³ã‚¯ã‚¨ã‚¹ãƒˆXï¼ˆDQ10ï¼‰ã®å ã„å¸«ç”¨ã‚¿ãƒ­ãƒƒãƒˆãƒ‡ãƒƒã‚­ã‚’æœ€é©åŒ–ã™ã‚‹ä¾¿åˆ©ãƒ„ãƒ¼ãƒ«ã€‚è¤‡æ•°ãƒ‡ãƒƒã‚­ã®ä¸€æ‹¬æœ€é©åŒ–ã€å¿…è¦ã‚«ãƒ¼ãƒ‰æšæ•°ã®æœ€å°åŒ–ã€ã‚ªãƒ¼ãƒ©ç™ºç”Ÿç‡ã‚’è€ƒæ…®ã—ãŸè‡ªå‹•æ§‹æˆãªã©ãŒå¯èƒ½ã§ã™ã€‚">
<meta property="og:image" content="https://surima-maker.github.io/dq10-tarot-tool/ogp.png?v=3">
<meta name="twitter:card" content="summary_large_image">
<style>
  :root { --main-bg: #c07848; --header-bg: #1a237e; --accent: #3949ab; --text: #333; --error: #c62828; --success: #2e7d32; }
  body { font-family: "Meiryo UI", sans-serif; margin: 0; padding: 0; color: var(--text); font-size: 13px; display: flex; flex-direction: column; min-height: 100vh; background-color: var(--main-bg); background-image: linear-gradient(335deg, rgba(0,0,0,0.15) 23px, transparent 23px), linear-gradient(155deg, rgba(0,0,0,0.15) 23px, transparent 23px), linear-gradient(335deg, rgba(0,0,0,0.15) 23px, transparent 23px), linear-gradient(155deg, rgba(0,0,0,0.15) 23px, transparent 23px); background-size: 58px 58px; background-position: 0px 2px, 4px 35px, 29px 31px, 34px 6px; }
  header { background: var(--header-bg); color: #fff; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
  h1 { margin: 0; font-size: 16px; font-weight: bold; }
  .sticky-header { position: sticky; top: 0; z-index: 100; background: #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
  .tabs { display: flex; border-bottom: 1px solid #ddd; }
  .tab-btn { flex: 1; padding: 12px 5px; border: none; background: #f9f9f9; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; color: #666; font-size: 12px; transition: 0.2s; }
  .tab-btn.active { border-bottom-color: var(--accent); color: var(--accent); background: #fff; }
  .tab-btn:hover { background: #eee; }
  .global-stats { display: flex; font-size: 14px; font-weight: bold; border-bottom: 1px solid #ddd; background: #e8eaf6; }
  .stat-box { flex: 1; padding: 10px; text-align: center; transition: 0.3s; }
  .stat-box.ok { background-color: #c8e6c9; color: #1b5e20; }
  .warning-bar { background: var(--error); color: #fff; padding: 8px; text-align: center; font-size: 12px; display: none; font-weight:bold; }
  .container { max-width: 800px; margin: 0 auto; padding: 15px; flex: 1; background: rgba(255, 255, 255, 0.6); border-radius: 8px; margin-top: 15px; margin-bottom: 15px; }
  .panel { display: none; animation: fadeIn 0.2s; background: #fff; padding: 15px; border-radius: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
  .panel.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
  table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 6px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; }
  th { background: #e0e0e0; padding: 8px; font-size: 11px; text-align: center; color: #555; }
  td { padding: 6px 8px; border-bottom: 1px solid #eee; vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  .click-row { cursor: pointer; transition: background-color 0.2s; }
  .click-row:hover { filter: brightness(0.95); }
  .desc-row td { background: #fafafa; font-size: 11px; color: #555; padding: 8px 15px; border-bottom: 2px solid #ddd; }
  .btn-count { width: 30px; height: 30px; border: none; border-radius: 4px; color: #fff; font-weight: bold; cursor: pointer; font-size: 16px; display:inline-flex; align-items:center; justify-content:center; }
  .btn-minus { background: #7B1FA2; }
  .btn-plus { background: #2E7D32; }
  .val-display { display: inline-block; width: 30px; text-align: center; font-weight: bold; font-size: 15px; }
  .btn-reset { background: #d32f2f; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-bottom: 10px; }
  .btn-primary { width: 100%; padding: 14px; background: var(--header-bg); color: #fff; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; transition:0.2s; }
  .btn-primary:hover { background: #283593; }
  .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
  .prio-group { display: flex; gap: 3px; justify-content: center; }
  .prio-btn { width: 28px; height: 24px; border: 1px solid #ccc; background: #fff; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: bold; color: #bbb; }
  .prio-btn.active-H { background: #1976d2; color: #fff; border-color:#1565c0; }
  .prio-btn.active-A { background: #d32f2f; color: #fff; border-color:#b71c1c; }
  .prio-btn.active-N { background: #43A047; color: #fff; border-color:#2e7d32; }
  .prio-btn.active-D { background: #FDD835; color: #333; border-color:#fbc02d; }
  .rank-badge { color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; display: inline-block; width: 30px; text-align: center; }
  .rk-SSS { background: #880e4f; } .rk-SS { background: #bf360c; } .rk-S { background: #e65100; } .rk-A { background: #1565c0; } .rk-B { background: #4e342e; }
  .res-card { display: inline-block; padding: 3px 6px; margin: 2px; border-radius: 4px; font-size: 11px; width: 65px; text-align: center; border:1px solid rgba(0,0,0,0.1); font-weight:bold; }
  .res-H { background: #BBDEFB; color: #0D47A1; }
  .res-A { background: #ffcdd2; color: #b71c1c; } 
  .res-N { background: #C8E6C9; color: #1B5E20; } 
  .res-D { background: #FFF9C4; color: #F57F17; } 
  .deck-item { background: #fff; border: 1px solid #ddd; margin-bottom: 8px; border-radius: 6px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
  .deck-header { padding: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: #fff; transition:0.2s; }
  .deck-header:hover { background: #f5f5f5; }
  .deck-name { font-weight: bold; color: var(--header-bg); font-size:14px; }
  .deck-body { display: none; padding: 15px; background: #fafafa; border-top: 1px solid #eee; font-size: 12px; }
  .deck-body.open { display: block; }
  .opt-res-row { display:flex; margin-bottom:5px; align-items: baseline; border-bottom:1px dashed #eee; padding-bottom:3px; }
  .opt-res-mon { font-weight: bold; width:130px; color:#444; }
  .btn-active-toggle { width: 60px; height: 26px; border: none; border-radius: 4px; font-size: 11px; font-weight: bold; cursor: pointer; margin-right: 10px; display: inline-flex; align-items: center; justify-content: center; }
  .btn-active-on { background: #2e7d32; color: #fff; }
  .btn-active-off { background: #9e9e9e; color: #fff; }
  .deck-item.inactive { opacity: 0.6; background: #eee; }
  .deck-item.inactive .deck-header { background: #eee; }
  .deck-item.inactive .deck-name { color: #888; }
  .save-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size:14px; }
  .info-box { background:#e3f2fd; padding:10px; border-radius:6px; margin-bottom:15px; font-size:12px; border-left:5px solid #1976d2; line-height:1.5; }
  .ex-tag { background: #ff9800; color: #fff; font-size: 10px; padding: 1px 4px; border-radius: 3px; margin-top: 2px; display:inline-block; }
  .loading { font-size: 14px; font-weight: bold; color: #ef6c00; padding: 20px; text-align: center; animation: blink 1s infinite; }
  @keyframes blink { 50% { opacity: 0.5; } }
  .action-buttons { display: flex; gap: 10px; margin-top: 15px; }

  /* æ‰€æŒæ•°è¨­å®šã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
  .stock-settings-header { cursor: pointer; background: #FFF9C4; padding: 10px; border: 1px solid #FBC02D; border-radius: 6px; margin-bottom: 10px; font-weight: bold; display:flex; justify-content:space-between; align-items:center; }
  .stock-settings-body { display: block; background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 20px; }
  .stock-item { display:flex; justify-content:space-between; align-items:center; border-bottom:1px dashed #eee; padding:5px 0; }
  .stock-input { width: 50px; padding:4px; text-align:center; font-weight:bold; border:1px solid #ccc; border-radius:3px; }

  footer { background: rgba(0, 0, 0, 0.75); color: #ddd; text-align: center; padding: 20px; font-size: 11px; margin-top: auto; border-top: 4px solid #3e2723; box-shadow: inset 0 10px 15px rgba(0,0,0,0.5); }
  footer a { color: #ffcc80; text-decoration: none; font-weight: bold; } 
  footer a:hover { text-decoration: underline; color: #fff; }
</style>
</head>
<body>

<header>
  <h1>ğŸ”® DQ10 ã‚¿ãƒ­ãƒƒãƒˆãƒ‡ãƒƒã‚­ä¾¿åˆ©ãƒ„ãƒ¼ãƒ«</h1>
</header>

<div class="sticky-header">
  <div id="warning-msg" class="warning-bar">âš ï¸ ã‚¢ãƒ«ã‚«ãƒŠã¨ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®åˆè¨ˆã‚’ãã‚Œãã‚Œ20æšã«ã—ã¦ãã ã•ã„</div>
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('arcana')">1. ã‚¢ãƒ«ã‚«ãƒŠ</button>
    <button class="tab-btn" onclick="switchTab('monster')">2. ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼</button>
    <button class="tab-btn" onclick="switchTab('exception')">3. ã‚¢ãƒ«ã‚«ãƒŠå›ºå®šã‚«ãƒ¼ãƒ‰é¸æŠ</button>
    <button class="tab-btn" onclick="switchTab('result')">4. ãƒ‡ãƒƒã‚­ä½œæˆ</button>
    <button class="tab-btn" onclick="switchTab('storage')">5. ãƒ‡ãƒƒã‚­ä¿å­˜/å¿…è¦ã‚«ãƒ¼ãƒ‰ç®—å‡º/æœ€é©åŒ–</button>
  </div>
  <div class="global-stats">
    <div id="stat-arc-container" class="stat-box">ã‚¢ãƒ«ã‚«ãƒŠ: <span id="stat-arc">0</span>/20</div>
    <div id="stat-mon-container" class="stat-box">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼: <span id="stat-mon">0</span>/20</div>
  </div>
</div>

<div class="container">
  
  <!-- TAB 1: Arcana -->
  <div id="panel-arcana" class="panel active">
    <div style="display:flex; justify-content: flex-end; align-items: center; margin-bottom: 10px;">
      <label style="margin-right: 10px; font-size: 12px; font-weight: bold; cursor: pointer;">
        <input type="checkbox" id="chk-reset-opt" checked> ã‚ªãƒ¼ãƒ©ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚‚åˆæœŸåŒ–
      </label>
      <button class="btn-reset" onclick="resetTab('arcana')" style="margin: 0;">ã“ã®ã‚¿ãƒ–ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    <div class="info-box">
      <b>ã‚ªãƒ¼ãƒ©ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦</b><br>
      æ‰‹æœ­ã§ã‚ªãƒ¼ãƒ©ã‚’ä½œã‚Šã‚„ã™ãã™ã‚‹ãŸã‚ã®è¨­å®šã§ã™ã€‚<br>
      Aã¨Hã‚’å„ªå…ˆçš„ã«çµ„ã¾ã›ã€Dã¨Hã‚’ã§ãã‚‹é™ã‚Šæ¸›ã‚‰ã™ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ¨å¥¨ã®è¨­å®šã§ã™ã€‚è‡ªç”±ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚<br><br>
      <b>H</b> (Hand): æ‰‹æœ­ã«æ®‹ã‚Šã‚„ã™ã„ãƒ»ä½é »åº¦ä½¿ç”¨<br>
      <b>A</b> (Aura): ã‚ªãƒ¼ãƒ©æ¨å¥¨<br>
      <b>N</b> (Normal): ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ»é«˜é »åº¦ä½¿ç”¨<br>
      <b>D</b> (Deprecated): ã‚ªãƒ¼ãƒ©éæ¨å¥¨ï¼ˆã‚ªãƒ¼ãƒ©æ•™çš‡ã®ãƒªã‚¸ã‚§ãƒã¯æ•™çš‡ã§å»¶é•·ã§ããªã„ãŸã‚ï¼‰
      
      <div style="margin-top: 12px; padding-top: 8px; border-top: 1px dashed #90caf9; font-size: 12px;">
        ğŸ’¡ <b>è©³ç´°ãƒ‡ãƒ¼ã‚¿</b><br>
        ã‚¿ãƒ­ãƒƒãƒˆã”ã¨ã®è©³ã—ã„å°„ç¨‹è·é›¢ã‚„åŠ¹æœç¯„å›²ã«ã¤ã„ã¦ã¯ã€<br>
        <a href="https://dragon-quest.jp/ten/job/uranai/range.php" target="_blank" rel="noopener noreferrer" style="color: #0d47a1; font-weight: bold; text-decoration: underline;">ãƒ‰ãƒ©ã‚¯ã‚¨10æ¥µé™æ”»ç•¥ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§˜</a> ã®ãƒšãƒ¼ã‚¸ãŒå¤§å¤‰å‚è€ƒã«ãªã‚Šã¾ã™ã€‚
      </div>
    </div>
    <table id="tbl-arcana">
      <thead><tr><th>ã‚¢ãƒ«ã‚«ãƒŠ</th><th>æšæ•°</th><th>ã‚ªãƒ¼ãƒ©ã‚ªãƒ—ã‚·ãƒ§ãƒ³</th></tr></thead>
      <tbody id="tbody-arcana"></tbody>
    </table>
  </div>

  <!-- TAB 2: Monster -->
  <div id="panel-monster" class="panel">
    <div style="display:flex; justify-content: flex-end; align-items: center; margin-bottom: 10px;">
      <button class="btn-reset" onclick="resetTab('monster')" style="margin: 0;">ã“ã®ã‚¿ãƒ–ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    <div class="info-box">
      â€»ãã•ã£ãŸæ­»ä½“ä»¥å¤–ã®Bãƒ©ãƒ³ã‚¯ä»¥ä¸‹ã¯çœç•¥ã—ã¦ã„ã¾ã™ã€‚(å¿…è¦ãªå ´åˆã¯ä½¿ã‚ãªã„ã‚«ãƒ¼ãƒ‰ã§ä»®ç½®ãã—ã¦ãã ã•ã„ã€‚)<br>
      Bãƒ©ãƒ³ã‚¯ã®ãã•ã£ãŸæ­»ä½“ã«ã¯ã€æ”»æ’ƒç³»ã‚¢ãƒ«ã‚«ãƒŠã¯è‡ªå‹•ã§ã¯å‰²ã‚Šå½“ã¦ã¾ã›ã‚“ã€‚<br>
      
      <div style="margin-top: 12px; padding-top: 8px; border-top: 1px dashed #90caf9; font-size: 12px;">
        ğŸ“– <b>ãƒ‡ãƒƒã‚­æ§‹ç¯‰ã®å‚è€ƒã‚µã‚¤ãƒˆæ§˜</b><br>
        <span style="display:inline-block; margin-top:4px;">
        ãƒ»ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®åˆæˆã«ã¤ã„ã¦: <a href="https://hotondo.work/archives/dqx-uranaishi-tarot-monster-review.html#i" target="_blank" rel="noopener noreferrer" style="color: #0d47a1; font-weight: bold; text-decoration: underline;">ã»ã¨ã‚“ã©ãƒ–ãƒ­ã‚° æ§˜ï¼ˆè¦‹ã‚„ã™ã„ã‚¿ãƒ­ãƒƒãƒˆåˆæˆæ—©è¦‹è¡¨ï¼‰</a>
        </span><br>
        <span style="display:inline-block; margin-top:4px;">
        ãƒ»æ§‹æˆã«è¿·ã£ãŸã‚‰: <a href="https://tetofamimura.livedoor.blog/archives/31325559.html" target="_blank" rel="noopener noreferrer" style="color: #0d47a1; font-weight: bold; text-decoration: underline;">ã¦ã¨ãƒ•ã‚¡ãƒŸæ‘ æ§˜ï¼ˆãŠã™ã™ã‚ãƒ‡ãƒƒã‚­è§£èª¬ï¼‰</a>
        </span>
      </div>
    </div>
    <table id="tbl-monster"><tbody id="tbody-monster"></tbody></table>
  </div>

  <!-- TAB 3: Fixed -->
  <div id="panel-exception" class="panel">
    <div style="display:flex; justify-content: flex-end; align-items: center; margin-bottom: 10px;">
      <button class="btn-reset" onclick="resetTab('exception')" style="margin: 0;">ã“ã®ã‚¿ãƒ–ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    <div class="info-box">
      ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®ã‚¢ãƒ«ã‚«ãƒŠã‚’å›ºå®šã—ã¾ã™ã€‚æœªè¨­å®šã®å ´åˆè‡ªç”±ã«å‰²ã‚ŠæŒ¯ã‚‰ã‚Œã¾ã™ã€‚<br>
      ã‚«ãƒ¼ãƒ‰ã‚’æ¶ˆè²»ã—ãªã„åŠ¹æœã‚„ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ãŒä¸ŠãŒã‚‹åŠ¹æœãªã©æŒã¤ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã¯å›ºå®šã‚’æ¨å¥¨ã—ã¦ã„ã¾ã™ã€‚
    </div>
    <div id="exception-content"></div>
  </div>

  <!-- TAB 4: Result -->
  <div id="panel-result" class="panel">
    <button id="btn-run" class="btn-primary" onclick="runSingleOptimizeUI()">ğŸ”„ ãƒ‡ãƒƒã‚­ä½œæˆ</button>
    <div id="result-content" style="margin-top:20px;"></div>
  </div>

  <!-- TAB 5: Storage -->
  <div id="panel-storage" class="panel">
    <div class="info-box" style="background:#fff3e0; border-left-color:#ff9800;">
      <b>âš¡ ä¸€æ‹¬æœ€é©åŒ–æ©Ÿèƒ½</b><br>
      ã‚«ãƒ¼ãƒ‰æšæ•°ãŒæœ€ã‚‚å°‘ãªãæ¸ˆã‚€çµ„ã¿åˆã‚ã›ã«æœ€é©åŒ–ã—ã¾ã™ã€‚ãã‚‰ã‚„ã¿ãƒãƒ¼ãƒ”ãƒ¼ãªã©ã®ä¸€éƒ¨ã®ãƒ‘ãƒƒã‚¯ã‹ã‚‰ã—ã‹å‡ºãªã„ä½¿ç”¨é »åº¦ã®é«˜ã„ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’å„ªå…ˆçš„ã«è¨ˆç®—ã—ã¾ã™ã€‚<br>
      ã“ã®æ©Ÿèƒ½ã¯å…¥ã£ã¦ã„ã‚‹ã‚¢ãƒ«ã‚«ãƒŠã‚„ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®æšæ•°ã¯å¤‰æ›´ã›ãšã€ã‚ãã¾ã§å‰²ã‚Šå½“ã¦ã®ã¿ã‚’å¤‰æ›´ã—ã¾ã™ã€‚ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ãŸã³ã«çµæœãŒå¤‰ã‚ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
    </div>
    
    <div style="margin-bottom:20px; display:flex; gap:10px;">
      <input type="text" id="deck-name-input" class="save-input" placeholder="ãƒ‡ãƒƒã‚­å (ä¾‹:æ±ç”¨ã€ä¸‡é­”ç”¨)">
      <button onclick="saveCurrentDeck()" style="padding:0 20px; background:var(--success); color:#fff; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">ä¿å­˜</button>
    </div>
    
    <div id="deck-list-container"></div>

    <!-- ãƒ¬ã‚¢ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼æ‰€æŒæ•°è¨­å®šã‚¨ãƒªã‚¢ -->
    <div style="margin-top:30px; border-top:2px dashed #ccc; padding-top:20px;">
      <div class="stock-settings-header" onclick="toggleStockSettings()">
        <span>ğŸ’ ãƒ¬ã‚¢ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼æ‰€æŒæ•°è¨­å®š</span>
        <span id="stock-toggle-icon">â–¼</span>
      </div>
      <div id="stock-settings-body" class="stock-settings-body">
        <div style="font-size:11px; color:#666; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
          <span>
            æ‰€æŒæ•°ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãã‚Œã‚’æœ€å„ªå…ˆã—ã¦è¶…ãˆãªã„ã‚ˆã†ã«æœ€é©åŒ–ã—ã¾ã™ï¼ˆ0ã¯ç„¡åˆ¶é™ï¼‰ã€‚<br>
            â€»è‰²ãƒ‘ãƒƒã‚¯ã‹ã‚‰å‡ºãªã„ä½¿ç”¨é »åº¦ã®é«˜ãã†ãªãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®ã¿å¯¾è±¡ã«ã—ã¦ã„ã¾ã™ã€‚<br>          </span>
          <button onclick="resetStockLimits()" style="padding:4px 8px; font-size:11px; cursor:pointer; background:#e0e0e0; border:1px solid #ccc; border-radius:4px;">ã™ã¹ã¦0ã«ã™ã‚‹</button>
        </div>
        <div id="stock-inputs-container"></div>
      </div>
      
      <div class="action-buttons">
        <button class="btn-primary" style="background:#0288D1; flex:1;" onclick="calculateNeedsOnly()">ğŸ“Š å¿…è¦æšæ•°ã‚’ç®—å‡º</button>
        <button class="btn-primary" style="background:#ef6c00; flex:2;" onclick="runHybridOptimization(false)">âš¡ ä¸€æ‹¬æœ€é©åŒ–</button>
        <button class="btn-primary" style="background:#8e24aa; flex:1;" onclick="runHybridOptimization(true)">ğŸ¤” ç†Ÿè€ƒãƒ¢ãƒ¼ãƒ‰</button>
      </div>
      <div id="global-result" style="margin-top:15px;"></div>
    </div>
    
    <div style="margin-top:40px; padding-top:20px; border-top:2px dashed #ccc;">
      <b>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— (ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ)</b>
      <textarea id="io-data" class="save-input" style="width:100%; height:60px; margin-top:10px; font-size:11px; font-family:monospace; line-height:1.2; resize:vertical;" placeholder="ã“ã“ã«ãƒ‡ãƒ¼ã‚¿ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚å¾©å…ƒã™ã‚‹éš›ã‚‚ã“ã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚"></textarea>
      <div class="action-buttons" style="margin-top:8px;">
        <button class="btn-primary" style="background:#424242; flex:1; padding:10px;" onclick="exportData()">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã™ã‚‹</button>
        <button class="btn-primary" style="background:#424242; flex:1; padding:10px;" onclick="importData()">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã™ã‚‹</button>
      </div>
    </div>
  </div>

</div>

<footer>
  â€»æœ¬ãƒ„ãƒ¼ãƒ«ã®ã‚¢ãƒ«ã‚«ãƒŠãŠã‚ˆã³ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®åŠ¹æœãƒ‡ãƒ¼ã‚¿ã¯ã€<br>
  <a href="https://wikiwiki.jp/dq10dic2nd/%E3%80%90%E3%83%A2%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%BC%E3%82%BF%E3%83%AD%E3%83%83%E3%83%88%E3%80%91#u55917ff" target="_blank" rel="noopener noreferrer">ã€DQ10å¤§è¾å…¸ã‚’ä½œã‚ã†ãœï¼ï¼ç¬¬äºŒç‰ˆ Wikiã€æ§˜ã®ãƒ‡ãƒ¼ã‚¿</a> ã‚’å¼•ç”¨ãƒ»å‚è€ƒã«ã•ã›ã¦ã„ãŸã ã„ã¦ãŠã‚Šã¾ã™ã€‚
</footer>

<script>
const ATK_ARCANAS = ['ç½ªäºº','æ­»ç¥','æ­£ç¾©','æˆ¦è»Š','å¡”'];
const H_ARCANAS = ['æ‚ªé­”','æ‹äºº','é‹å‘½','å¥³æ•™çš‡','å¯©åˆ¤','å¥³å¸','æœˆ','æ˜Ÿ'];

const ARCANA_DATA = [
  {name:'æ­£ç¾©',limit:4, color:'#ffebee', desc:'æ”»é­”ä¾å­˜ã®å…‰å±æ€§å˜ä½“æ”»æ’ƒ<br>æ•µãŒæ€’ã£ã¦ã„ã‚‹ã¨å¨åŠ›ä¸Šæ˜‡'}, 
  {name:'æˆ¦è»Š',limit:4, color:'#ffebee', desc:'æ”»æ’ƒåŠ›ä¾å­˜ã®ç„¡å±æ€§å˜ä½“æ”»æ’ƒã€‚<br>è‡ªåˆ†ã«è‰¯ã„åŠ¹æœãŒã‚ã‚‹ã»ã©å¨åŠ›ä¸Šæ˜‡'}, 
  {name:'æ­»ç¥',limit:4, color:'#ffebee', desc:'æ”»é­”ä¾å­˜ã®é—‡å±æ€§ç¯„å›²æ”»æ’ƒ<br>HPæ¸›å°‘ã®å‘ªã„'}, 
  {name:'å¡”',limit:4, color:'#ffebee', desc:'æ”»é­”ä¾å­˜ã®é›·å±æ€§ç¯„å›²æ”»æ’ƒ<br>é—‡è€æ€§ä½ä¸‹ä»˜ä¸'},
  {name:'ç½ªäºº',limit:4, color:'#ffebee', desc:'æ”»é­”ä¾å­˜ã®é—‡å±æ€§å˜ä½“æ”»æ’ƒ<br>æ•µã«æ‚ªã„åŠ¹æœãŒã‚ã‚‹ã»ã©å¨åŠ›ä¸Šæ˜‡'}, 
  {name:'éš è€…',limit:4, color:'#ffebee', desc:'æ”»é­”ä¾å­˜ã®é—‡å±æ€§å˜ä½“æ”»æ’ƒ<br>é›·è€æ€§ä½ä¸‹ä»˜ä¸'}, 
  {name:'åŠ›',limit:4, color:'#e3f2fd', desc:'è‡ªåˆ†ã¨å‘¨å›²ã®å‘³æ–¹ãƒã‚¤ã‚­ãƒ«ãƒˆ'},   
  {name:'é­”è¡“å¸«',limit:5, color:'#e3f2fd', desc:'å‘³æ–¹1äººã«ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã‚’2æ®µéšä¸Šæ˜‡(è‡ªåˆ†ä¸å¯)'},
  {name:'æ‹äºº',limit:4, color:'#e3f2fd', desc:'å‘³æ–¹1äººã«ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯(è‡ªåˆ†ä¸å¯)'}, 
  {name:'æ‚ªé­”',limit:4, color:'#e3f2fd', desc:'æ•µå˜ä½“ã«ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯'}, 
  {name:'çš‡å¸',limit:2, color:'#e3f2fd', desc:'å‘³æ–¹1äººã«ãƒãƒ£ãƒ¼ã‚¸æ™‚é–“çŸ­ç¸®(10ç§’/ã‚ªãƒ¼ãƒ©15ç§’)'}, 
  {name:'ä¸–ç•Œ',limit:4, color:'#e3f2fd', desc:'è‡ªåˆ†ã¨å‘¨å›²ã®å‘³æ–¹ã«ã‚¹ãƒšãƒ«ã‚¬ãƒ¼ãƒ‰'}, 
  {name:'æ•™çš‡',limit:4, color:'#e8f5e9', desc:'è‡ªåˆ†ã¨å‘¨å›²ã®å‘³æ–¹ã«ã‚¹ã‚¯ãƒ«ãƒˆï¼‹ãƒªã‚¸ã‚§ãƒ'}, 
  {name:'å¥³æ•™çš‡',limit:4, color:'#e8f5e9', desc:'ä»²é–“1äººã®HPã‚’å›å¾©ã—ã€æ‚ªã„åŠ¹æœã‚’æ¶ˆã™'}, 
  {name:'ç¯€åˆ¶',limit:2, color:'#e8f5e9', desc:'è‡ªåˆ†ã¨å‘¨å›²ã®å‘³æ–¹ã«3ç§’ã«MP(5/ã‚ªãƒ¼ãƒ©10)ãšã¤å›å¾©ã®åŠ¹æœ'}, 
  {name:'å¤ªé™½',limit:2, color:'#e8f5e9', desc:'ãƒ™ãƒ›ãƒãƒ©ãƒ¼'},
  {name:'å¯©åˆ¤',limit:2, color:'#e8f5e9', desc:'è‡ªåˆ†ã®å‘¨å›²ç¯„å›²è˜‡ç”Ÿ åŸºç¤8m'}, 
  {name:'é‹å‘½',limit:4, color:'#e8f5e9', desc:'é•·å°„ç¨‹å˜ä½“è˜‡ç”Ÿ åŸºç¤10m'}, 
  {name:'æœˆ',limit:4, color:'#f3e5f5', desc:'å¹»æƒ‘åŠ¹æœã®é™£'},   
  {name:'æ˜Ÿ',limit:4, color:'#f3e5f5', desc:'çœ ã‚ŠåŠ¹æœã®é™£'},
  {name:'æ„šè€…',limit:2, color:'#f3e5f5', desc:'è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸1.2å€ã®é™£'}, 
  {name:'å¥³å¸',limit:4, color:'#f3e5f5', desc:'å¯¾è±¡ã¨ãã®å‘¨å›²ã®æ•µã«é­…äº†'}
];

const MONSTER_DATA = [
  {name:'ã‚¢ãƒˆãƒ©ã‚¹',rank:'SSS',limit:1,ex:true, desc:'ä½¿ç”¨æ™‚ã®ä¼šå¿ƒç‡30%'}, {name:'ãƒã‚ºã‚º',rank:'SSS',limit:1,ex:true, desc:'ä½¿ç”¨æ™‚50%ã§ãƒ†ãƒ³ã‚·ãƒ§ãƒ³æ¶ˆè²»ã—ãªã„'},
  {name:'ãƒ™ãƒªã‚¢ãƒ«',rank:'SSS',limit:1,ex:true, desc:'ã‚ªãƒ¼ãƒ©ãŒå®¿ã‚‹ã¨ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ä¸Šæ˜‡'}, {name:'ãƒãƒ©ãƒ¢ã‚¹ã‚¾ãƒ³ãƒ“',rank:'SSS',limit:1,ex:true, desc:'ä½¿ç”¨æ™‚30%ã§æ‰‹æœ­ã«æ®‹ã‚‹'},
  {name:'ãƒãƒ©ãƒ¢ã‚¹ãƒ–ãƒ­ã‚¹',rank:'SSS',limit:1,ex:true, desc:'ä½¿ç”¨æ™‚30%ã§æ‰‹æœ­ã«æ®‹ã‚‹'}, {name:'ã‚­ãƒ³ã‚°ãƒ’ãƒ‰ãƒ©',rank:'SSS',limit:1,ex:true, desc:'ã‚ªãƒ¼ãƒ©ãŒå®¿ã‚‹ã¨ä½¿ç”¨æ™‚ã®æ”»æ’ƒãƒ€ãƒ¡ãƒ¼ã‚¸ãƒ»å›å¾©é‡ï¼‹200%'},
  {name:'ã‚¢ã‚¯ãƒãƒ¼',rank:'SSS',limit:1,ex:true, desc:'æ‰‹æœ­ã«å…¥ã£ãŸæ™‚è‡ªåˆ†ã®HP30%å›å¾©'}, {name:'ãƒ‡ãƒ¥ãƒ©ãƒ³',rank:'SSS',limit:1,ex:true, desc:'è‡ªåˆ†ã®HPãŒå…¨å¿«ãªã‚‰ä½¿ç”¨æ™‚åŠ¹æœ2å›ç™ºå‹•'},
  {name:'ã‚¸ãƒ£ãƒŸãƒ©ã‚¹',rank:'SSS',limit:1,ex:true, desc:'è‡ªåˆ†ã®HPãŒå…¨å¿«ãªã‚‰ä½¿ç”¨æ™‚ã®å›å¾©2å€'}, {name:'ã‚°ãƒ©ã‚³ã‚¹',rank:'SSS',limit:1,ex:true, desc:'æ‰‹æœ­ã«å…¥ã£ãŸæ™‚è‡ªåˆ†ã®HP&MP10%å›å¾©'},
  {name:'ã‚ãŸã¼ã†',rank:'SS',limit:1,ex:true, desc:'æˆ¦é—˜é–‹å§‹æ™‚ã«å¿…ãšæ‰‹æœ­ã«å…¥ã‚‹'}, {name:'ãƒ¯ãƒ«ã¼ã†',rank:'SS',limit:1,ex:true, desc:'æ‰‹æœ­ã«å…¥ã£ãŸæ™‚ã€ä»–ã®ã‚¿ãƒ­ãƒƒãƒˆã®ã‚ªãƒ¼ãƒ©æ¡ä»¶ã®ä»£ã‚ã‚Šã«ãªã‚‹'},
  {name:'ã‚¨ãƒ³ã‚¼ãƒ«ã‚¹ãƒ©ã‚¤ãƒ ',rank:'SS',limit:2,ex:true, desc:'ã€Œã‚¨ãƒ³ã‚¼ãƒ«ã®ã¿ã¡ã³ãã€ä½¿ç”¨æ™‚ã«æ‰‹æœ­ã«å‘¼ã¹ã‚‹'}, {name:'ãƒ¡ã‚«ãƒãƒ¼ãƒ³',rank:'SS',limit:2,ex:false, desc:'å—ã‘ã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸5æ¸›å°‘'},
  {name:'ãƒã‚¯ãƒ­ãƒãƒ«ã‚µ',rank:'SS',limit:2,ex:true, desc:'æ‰‹æœ­ã«å…¥ã£ãŸæ™‚20%ã§ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ä¸Šæ˜‡'}, {name:'ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¹ãƒ©ã‚¤ãƒ ',rank:'SS',limit:2,ex:false, desc:'æœ€å¤§HP+15'},
  {name:'ãƒ—ãƒ©ãƒãƒŠã‚­ãƒ³ã‚°',rank:'SS',limit:2,ex:false, desc:'æœ€å¤§HPï¼‹8'}, {name:'Sã‚­ãƒ©ãƒ¼ãƒã‚·ãƒ³',rank:'SS',limit:2,ex:false, desc:'ã¡ã‹ã‚‰+12'},
  {name:'ã‚­ãƒ©ãƒ¼ãƒã‚¸ãƒ³ã‚¬',rank:'SS',limit:2,ex:false, desc:'ã¡ã‹ã‚‰ï¼‹8'}, {name:'ãƒ©ãƒ³ãƒ—ã®ã¾ãŠã†',rank:'SS',limit:2,ex:false, desc:'ã“ã†ã’ãé­”åŠ›+30'},
  {name:'ãƒ˜ãƒ«ãƒãƒˆãƒ©ãƒ¼',rank:'SS',limit:2,ex:false, desc:'ã“ã†ã’ãé­”åŠ›ï¼‹24'}, {name:'ãƒ¡ã‚¤ãƒ‡ãƒ³ãƒ‰ãƒ¼ãƒ«',rank:'SS',limit:2,ex:false, desc:'ã‹ã„ãµãé­”åŠ›+30'},
  {name:'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ãƒ›ãƒ¼ã‚¹',rank:'SS',limit:2,ex:false, desc:'ã‹ã„ãµãé­”åŠ›ï¼‹25'},
  {name:'ãã‚‰ã‚„ã¿ãƒãƒ¼ãƒ”ãƒ¼',rank:'S',limit:2,ex:false, desc:'è¨­ç½®å‹ä»¥å¤–ã®ã‚¿ãƒ­ãƒƒãƒˆã®åŠ¹æœç¯„å›²+0.5mã€ã‚¿ãƒ­ãƒƒãƒˆã®å°„ç¨‹è·é›¢ï¼‹0.5m'}, {name:'ãƒŸã‚±ã¾ã©ã†',rank:'S',limit:2,ex:false, desc:'ã‚¿ãƒ­ãƒƒãƒˆã®å°„ç¨‹è·é›¢ï¼‹2m'},
  {name:'ãƒãƒƒãƒ‰ã‚¹ãƒŸã‚¹',rank:'S',limit:2,ex:false, desc:'è¨­ç½®å‹ä»¥å¤–ã®ã‚¿ãƒ­ãƒƒãƒˆã®åŠ¹æœç¯„å›²ï¼‹1m'}, {name:'ã‚¹ã‚¦ã‚£ãƒ¼ãƒˆãƒãƒƒã‚°',rank:'S',limit:5,ex:true, desc:'ä½¿ç”¨æ™‚30%ã§æ‰‹æœ­ã«æ®‹ã‚‹'}, {name:'ãƒ¡ã‚¿ãƒ«ã‚­ãƒ³ã‚°',rank:'S',limit:5,ex:false, desc:'æœ€å¤§HPï¼‹3'}, {name:'ãƒ¡ã‚¿ãƒ«ã‚¹ãƒ©ã‚¤ãƒ ',rank:'S',limit:5,ex:false, desc:'èº«ã‹ã‚ã—ç‡ï¼‹0.3%'},
  {name:'ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚³ãƒ¼ãƒ³',rank:'S',limit:5,ex:false, desc:'ã™ã°ã‚„ã•ï¼‹8'}, {name:'ã¤ã‚€ã‚Šã‚“ãƒãƒ',rank:'S',limit:5,ex:false, desc:'ã¿ã®ã¾ã‚‚ã‚Šï¼‹4'},
  {name:'ãƒ¡ã‚¿ãƒ«ãƒ›ã‚¤ãƒŸãƒ³',rank:'S',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚è‡ªåˆ†ã®HP25å›å¾©'}, {name:'ãƒ„ãƒ³ãƒ‰ãƒ©ã‚­ãƒ¼',rank:'S',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚è‡ªåˆ†ã®MP12å›å¾©'},
  {name:'ã¡ã‚‡ã†ã‚ã†ã˜ã‚…',rank:'S',limit:5,ex:false, desc:'ã‹ã„ãµãé­”åŠ›ï¼‹8'}, {name:'ãƒ™ãƒ“ãƒ³ã‚´ã‚µã‚¿ãƒ³',rank:'S',limit:5,ex:false, desc:'ã“ã†ã’ãé­”åŠ›ï¼‹8'},
  {name:'ãƒ ãƒ¼ãƒ³ã‚­ãƒ¡ãƒ©',rank:'S',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚è‡ªåˆ†ã®HP12%å›å¾©'}, {name:'ã‚­ãƒ©ãƒ¼ãƒ”ãƒƒã‚±ãƒ«',rank:'S',limit:5,ex:true, desc:'æ‰‹æœ­ã«å…¥ã£ãŸæ™‚10%ã§ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ä¸Šæ˜‡'},
  {name:'ã‚¹ã‚¤ãƒ¼ãƒ„ãƒˆãƒ­ãƒ«',rank:'S',limit:5,ex:true, desc:'æ‰‹æœ­ã«å…¥ã£ãŸæ™‚15%ã§ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ä¸Šæ˜‡'}, {name:'ãƒ¢ãƒƒãƒ„ã‚¡ãƒ¬ãƒ¼ãƒ©',rank:'S',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚è‡ªåˆ†ã®MP50å›å¾©'},
  {name:'ãƒ”ãƒ³ã‚¯ãƒœãƒ³ãƒœãƒ³',rank:'S',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚å‘³æ–¹å…¨å“¡ã®HP12%å›å¾©'}, 
  {name:'æ­»ã®ã‚«ãƒ©ã‚¹ãƒ†ãƒ³ã‚°',rank:'S',limit:5,ex:false, desc:'æœ€å¤§MPï¼‹15'}, {name:'ã‚¿ã‚¤ãƒ—G',rank:'S',limit:5,ex:false, desc:'ã¡ã‹ã‚‰ï¼‹4'},
  {name:'ã‚¢ã‚¹ã‚¿ãƒ­ãƒˆ',rank:'S',limit:5,ex:true, desc:'ä½¿ç”¨æ™‚20%ã§ãƒ†ãƒ³ã‚·ãƒ§ãƒ³æ¶ˆè²»ã—ãªã„'},
  {name:'ã‚­ãƒ³ã‚°ã‚¨ãƒ¬ãƒ•ã‚¡ãƒ³ãƒˆ',rank:'S',limit:5,ex:true, desc:'ä½¿ç”¨æ™‚30%ã§åŠ¹æœ2å›ç™ºå‹•'},
  {name:'ãƒªãƒ“ãƒ³ã‚°ãƒ‡ãƒƒãƒ‰',rank:'A',limit:2,ex:false, desc:'è¨­ç½®å‹ä»¥å¤–ã®ã‚¿ãƒ­ãƒƒãƒˆã®åŠ¹æœç¯„å›²ï¼‹0.3m'}, {name:'ã‚¹ãƒ©ã‚¤ãƒ ã‚¿ãƒ¯ãƒ¼',rank:'A',limit:5,ex:false, desc:'èº«ã‹ã‚ã—ç‡ï¼‹0.2%'},
  {name:'ãƒ–ãƒ©ãƒãƒ‹ã‚¯ã‚¤ãƒ¼ãƒ³',rank:'A',limit:5,ex:false, desc:'ã™ã°ã‚„ã•ï¼‹7'}, {name:'ã¤ã‚‰ã‚‰ã‚¹ãƒ©ã‚¤ãƒ ',rank:'A',limit:5,ex:false, desc:'ã¿ã®ã¾ã‚‚ã‚Šï¼‹3'},
  {name:'ãƒ™ãƒ›ãƒã‚¹ãƒ©ã‚¤ãƒ ',rank:'A',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚è‡ªåˆ†ã®HP20å›å¾©'}, {name:'ãƒ‰ãƒ©ã‚­ãƒ¼ãƒ',rank:'A',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚è‡ªåˆ†ã®MP10å›å¾©'},
  {name:'ã‚¨ãƒ“ãƒ«ãƒˆãƒ¬ãƒ³ãƒˆ',rank:'A',limit:5,ex:false, desc:'ã‹ã„ãµãé­”åŠ›ï¼‹5'}, {name:'ãƒŸãƒ‹ãƒ‡ãƒ¼ãƒ¢ãƒ³',rank:'A',limit:5,ex:false, desc:'ã“ã†ã’ãé­”åŠ›ï¼‹5'},
  {name:'ãƒ€ãƒ¼ã‚¯ãƒšãƒ«ã‚·ãƒ£',rank:'A',limit:5,ex:false, desc:'ã‚¿ãƒ­ãƒƒãƒˆã®å°„ç¨‹è·é›¢ï¼‹0.5m'}, {name:'ã‚¹ã‚¿ãƒ¼ã‚­ãƒ¡ãƒ©',rank:'A',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚è‡ªåˆ†ã®HP5%å›å¾©'},
  {name:'ãƒ–ãƒ©ãƒ³ãƒãƒˆãƒƒã‚¯',rank:'A',limit:5,ex:false, desc:'æ‰‹æœ­ã«å…¥ã£ãŸæ™‚5%ã§ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ä¸Šæ˜‡'}, {name:'ãƒˆãƒ­ãƒ«ã‚­ãƒ³ã‚°',rank:'A',limit:5,ex:false, desc:'æ‰‹æœ­ã«å…¥ã£ãŸæ™‚10%ã§ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ä¸Šæ˜‡'},
  {name:'ãã‚ã‚«ãƒ“ã“ãã†',rank:'A',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚è‡ªåˆ†ã®MP30å›å¾©'}, {name:'ãƒ•ã‚¡ãƒ¼ãƒ©ãƒƒãƒˆ',rank:'A',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚å‘³æ–¹å…¨å“¡ã®HP5%å›å¾©'},
  {name:'ãŠã©ã‚‹ã»ã†ã›ã',rank:'A',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚10%ã§æ‰‹æœ­ã«æ®‹ã‚‹'}, {name:'ã‚¬ãƒ¼ã‚´ã‚¤ãƒ«',rank:'A',limit:5,ex:false, desc:'æœ€å¤§MPï¼‹5'},
  {name:'ã‚­ãƒ©ãƒ¼ãƒã‚·ãƒ³',rank:'A',limit:5,ex:false, desc:'ã¡ã‹ã‚‰ï¼‹3'}, {name:'ã‚¯ã‚¤ãƒ¼ãƒ³ã‚¹ãƒ©ã‚¤ãƒ ',rank:'A',limit:5,ex:false, desc:'æœ€å¤§HPï¼‹2'},
  {name:'ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ãƒ¼ãƒ³',rank:'A',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚10%ã§ãƒ†ãƒ³ã‚·ãƒ§ãƒ³æ¶ˆè²»ã—ãªã„'}, {name:'ã‚¬ãƒãƒ¼ã‚·ãƒ£ã‚¨ãƒ“ãƒ«',rank:'A',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚10%ã§åŠ¹æœ2å›ç™ºå‹•'},
  {name:'ãã•ã£ãŸæ­»ä½“',rank:'B',limit:2,ex:true, desc:'è¨­ç½®å‹ä»¥å¤–ã®ã‚¿ãƒ­ãƒƒãƒˆã®åŠ¹æœç¯„å›²ï¼‹0.1m'}
];

const TARGET_RARES = [
  {name:'ãã‚‰ã‚„ã¿ãƒãƒ¼ãƒ”ãƒ¼', w:100000}, {name:'ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¹ãƒ©ã‚¤ãƒ ', w:100000}, 
  {name:'Sã‚­ãƒ©ãƒ¼ãƒã‚·ãƒ³', w:100000}, {name:'ãƒ¡ã‚¤ãƒ‡ãƒ³ãƒ‰ãƒ¼ãƒ«', w:100000},
  {name:'ãƒ¡ã‚«ãƒãƒ¼ãƒ³', w:50000}, {name:'ã‚­ãƒ©ãƒ¼ãƒã‚¸ãƒ³ã‚¬', w:50000}, 
  {name:'ãƒã‚¯ãƒ­ãƒãƒ«ã‚µ', w:50000}, {name:'ãƒ—ãƒ©ãƒãƒŠã‚­ãƒ³ã‚°', w:50000},
  {name:'ãƒ©ãƒ³ãƒ—ã®ã¾ãŠã†', w:50000}, {name:'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ãƒ›ãƒ¼ã‚¹', w:50000}
];

function getWeight(mName) {
  let r = TARGET_RARES.find(x => x.name === mName);
  if(r) return r.w;
  const rank = MONSTER_DATA.find(m=>m.name===mName).rank;
  if(rank === 'SSS') return 1000;
  if(rank === 'SS') return 500;
  if(rank === 'S') return 100;
  if(rank === 'A') return 10;
  return 1;
}

const sleep = ms => new Promise(r => setTimeout(r, ms));

const STORAGE_KEY_STATE = 'dq10_tarot_tool_state';
const STORAGE_KEY_DECKS = 'dq10_tarot_tool_decks';
const STORAGE_KEY_STOCKS = 'dq10_tarot_tool_stocks';

let appState = { arcanaCounts: {}, arcanaPriorities: {}, monsterCounts: {}, exceptionData: {}, optimizedResult: {} };
let savedDecks = [];
let backupDecks = null; 
let activeTabId = 'arcana';
let rareStockLimits = {};
let globalMemo = {}; 

window.onload = () => {
  const s = localStorage.getItem(STORAGE_KEY_STATE); if(s) appState = JSON.parse(s); else resetStateBase();
  const d = localStorage.getItem(STORAGE_KEY_DECKS); if(d) savedDecks = JSON.parse(d);
  const st = localStorage.getItem(STORAGE_KEY_STOCKS); if(st) rareStockLimits = JSON.parse(st);
  renderAll();
  renderStockSettings();
};

function resetStateBase() {
  ARCANA_DATA.forEach(a => {
    appState.arcanaCounts[a.name] = 0;
    let p = 'N'; if(ATK_ARCANAS.includes(a.name)) p = 'A'; else if(a.name === 'æ•™çš‡') p = 'D'; else if(H_ARCANAS.includes(a.name)) p = 'H';
    appState.arcanaPriorities[a.name] = p;
  });
  appState.monsterCounts = {}; appState.exceptionData = {}; appState.optimizedResult = {};
}

function resetTab(tabId) {
  if(!confirm('ç¾åœ¨ã®ã‚¿ãƒ–ã®å†…å®¹ã®ã¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  if(tabId === 'arcana') {
    const resetOpt = document.getElementById('chk-reset-opt').checked;
    ARCANA_DATA.forEach(a => {
      appState.arcanaCounts[a.name] = 0;
      if(resetOpt) {
        let p = 'N'; if(ATK_ARCANAS.includes(a.name)) p = 'A'; else if(a.name === 'æ•™çš‡') p = 'D'; else if(H_ARCANAS.includes(a.name)) p = 'H';
        appState.arcanaPriorities[a.name] = p;
      }
    });
  } else if(tabId === 'monster') {
    appState.monsterCounts = {}; appState.exceptionData = {};
  } else if(tabId === 'exception') {
    appState.exceptionData = {};
  }
  saveData(); renderAll();
}

function saveData() { localStorage.setItem(STORAGE_KEY_STATE, JSON.stringify(appState)); updateStats(); }

function updateStats() {
  let aCount = Object.values(appState.arcanaCounts).reduce((a,b)=>a+b,0);
  let mCount = Object.values(appState.monsterCounts).reduce((a,b)=>a+b,0);
  let arcEl = document.getElementById('stat-arc');
  let monEl = document.getElementById('stat-mon');
  let arcCont = document.getElementById('stat-arc-container');
  let monCont = document.getElementById('stat-mon-container');
  arcEl.textContent = aCount; monEl.textContent = mCount;
  
  if(aCount === 20) arcCont.classList.add('ok'); else arcCont.classList.remove('ok');
  if(mCount === 20) monCont.classList.add('ok'); else monCont.classList.remove('ok');

  const warn = document.getElementById('warning-msg');
  const btn = document.getElementById('btn-run');
  if(aCount !== 20 || mCount !== 20) { 
    btn.disabled = true; 
    if(activeTabId === 'result') warn.style.display = 'block'; else warn.style.display = 'none';
  } else { 
    btn.disabled = false; 
    warn.style.display = 'none'; 
  }
}

function toggleDesc(id) {
  const el = document.getElementById(id);
  if(el) el.style.display = (el.style.display === 'none') ? 'table-row' : 'none';
}

function renderAll() { renderArcana(); renderMonster(); renderException(); renderDeckList(); }

function renderArcana() {
  const tbody = document.getElementById('tbody-arcana'); tbody.innerHTML = '';
  ARCANA_DATA.forEach(a => {
    const cnt = appState.arcanaCounts[a.name] || 0; const prio = appState.arcanaPriorities[a.name];
    const tr = document.createElement('tr'); tr.style.backgroundColor = a.color; tr.className = 'click-row';
    tr.onclick = () => toggleDesc('arc-desc-' + a.name);
    tr.innerHTML = `<td><b>${a.name}</b></td>
      <td><div style="display:flex; align-items:center;">
      <button class="btn-count btn-minus" onclick="event.stopPropagation(); modArc('${a.name}', -1, ${a.limit})">ï¼</button>
      <span class="val-display">${cnt}</span>
      <button class="btn-count btn-plus" onclick="event.stopPropagation(); modArc('${a.name}', 1, ${a.limit})">ï¼‹</button></div></td>
      <td><div class="prio-group">${['H','A','N','D'].map(x => `<button class="prio-btn ${prio===x?'active-'+x:''}" onclick="event.stopPropagation(); setPrio('${a.name}', '${x}')">${x}</button>`).join('')}</div></td>`;
    tbody.appendChild(tr);
    const trDesc = document.createElement('tr'); trDesc.id = 'arc-desc-' + a.name; trDesc.className = 'desc-row'; trDesc.style.display = 'none';
    trDesc.innerHTML = `<td colspan="3">${a.desc}</td>`;
    tbody.appendChild(trDesc);
  });
  updateStats();
}
function modArc(name, d, limit) { let v = (appState.arcanaCounts[name] || 0) + d; if(v < 0) v = 0; if(v > limit) v = limit; appState.arcanaCounts[name] = v; saveData(); renderArcana(); }
function setPrio(name, p) { appState.arcanaPriorities[name] = p; saveData(); renderArcana(); }

function renderMonster() {
  const tbody = document.getElementById('tbody-monster'); tbody.innerHTML = ''; let lastRank = '';
  MONSTER_DATA.forEach(m => {
    if(m.rank !== lastRank) { const trH = document.createElement('tr'); trH.innerHTML = `<td colspan="2" style="background:#eee; font-weight:bold; font-size:11px; padding:6px;">â–¼ ${m.rank}ãƒ©ãƒ³ã‚¯</td>`; tbody.appendChild(trH); lastRank = m.rank; }
    if(m.name === 'ãƒãƒ©ãƒ¢ã‚¹ã‚¾ãƒ³ãƒ“' || m.name === 'ã‚¢ã‚¯ãƒãƒ¼') {
      const trLine = document.createElement('tr'); trLine.innerHTML = `<td colspan="2" style="border-top: 2px dashed #9fa8da; padding: 0; height: 0;"></td>`; tbody.appendChild(trLine);
    }
    const cnt = appState.monsterCounts[m.name] || 0; const tr = document.createElement('tr'); 
    if(cnt > 0) tr.style.backgroundColor = '#e8f5e9'; else tr.style.backgroundColor = '#fff';
    tr.className = 'click-row'; tr.onclick = () => toggleDesc('mon-desc-' + m.name);
    tr.innerHTML = `<td><span class="rank-badge rk-${m.rank}">${m.rank}</span> <b>${m.name}</b></td>
      <td style="text-align:right;"><div style="display:flex; align-items:center; justify-content:flex-end;">
      <button class="btn-count btn-minus" onclick="event.stopPropagation(); modMon('${m.name}', -1, ${m.limit})">ï¼</button>
      <span class="val-display">${cnt}</span><button class="btn-count btn-plus" onclick="event.stopPropagation(); modMon('${m.name}', 1, ${m.limit})">ï¼‹</button></div></td>`;
    tbody.appendChild(tr);
    const trDesc = document.createElement('tr'); trDesc.id = 'mon-desc-' + m.name; trDesc.className = 'desc-row'; trDesc.style.display = 'none';
    trDesc.innerHTML = `<td colspan="2">${m.desc}</td>`;
    tbody.appendChild(trDesc);
  });
  updateStats();
}
function modMon(name, d, limit) { let v = (appState.monsterCounts[name] || 0) + d; if(v < 0) v = 0; if(v > limit) v = limit; appState.monsterCounts[name] = v; saveData(); renderMonster(); renderException(); }

function renderException() {
  const c = document.getElementById('exception-content'); c.innerHTML = '';
  const am = MONSTER_DATA.filter(m => (appState.monsterCounts[m.name] || 0) > 0);
  if(am.length === 0) { c.innerHTML = '<div style="padding:15px; text-align:center; color:#888; background:#fff; border-radius:6px; border:1px solid #eee;">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</div>'; return; }
  am.sort((a,b) => (b.ex ? 1 : 0) - (a.ex ? 1 : 0));
  let html = '<table><thead><tr><th style="width:140px;">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼</th><th>å›ºå®šã‚¢ãƒ«ã‚«ãƒŠ</th></tr></thead><tbody>';
  am.forEach(m => {
    const cnt = appState.monsterCounts[m.name]; let selHTML = '';
    for(let i=0; i<cnt; i++) {
      const savedVal = (appState.exceptionData[m.name] || [])[i] || ''; const color = getArcanaColor(savedVal);
      let opts = `<option value="">(è‡ªå‹•)</option>`;
      ARCANA_DATA.filter(a => appState.arcanaCounts[a.name] > 0).forEach(a => { opts += `<option value="${a.name}" ${savedVal===a.name?'selected':''} style="background:${a.color}">${a.name}</option>`; });
      selHTML += `<select onchange="updateEx('${m.name}', ${i}, this)" style="margin-bottom:4px; display:block; background:${color}; width:100%; border:1px solid #ccc; padding:6px; font-weight:bold;">${opts}</select>`;
    }
    let bg = m.ex ? '#fff9c4' : '#fff';
    html += `<tr style="background:${bg};"><td><b>${m.name}</b>${m.ex?'<br><span class="ex-tag">æ¨å¥¨</span>':''}</td><td>${selHTML}</td></tr>`;
  });
  html += '</tbody></table>';
  c.innerHTML = html;
}
function updateEx(mName, idx, el) { if(!appState.exceptionData[mName]) appState.exceptionData[mName] = []; appState.exceptionData[mName][idx] = el.value; el.style.backgroundColor = getArcanaColor(el.value); saveData(); }
function getArcanaColor(name) { const f = ARCANA_DATA.find(a=>a.name===name); return f ? f.color : '#fff'; }

function renderStockSettings() {
  const container = document.getElementById('stock-inputs-container');
  container.innerHTML = '';
  TARGET_RARES.forEach(r => {
    let limit = rareStockLimits[r.name] || 0;
    let div = document.createElement('div');
    div.className = 'stock-item';
    div.innerHTML = `<span>${r.name}</span> <input type="number" min="0" value="${limit}" class="stock-input" onchange="updateStock('${r.name}', this.value)">`;
    container.appendChild(div);
  });
}
function updateStock(name, val) {
  rareStockLimits[name] = parseInt(val) || 0;
  localStorage.setItem(STORAGE_KEY_STOCKS, JSON.stringify(rareStockLimits));
}
function resetStockLimits() {
  rareStockLimits = {};
  localStorage.setItem(STORAGE_KEY_STOCKS, JSON.stringify(rareStockLimits));
  renderStockSettings();
}
function toggleStockSettings() {
  const body = document.getElementById('stock-settings-body');
  const icon = document.getElementById('stock-toggle-icon');
  if(body.style.display === 'none') { body.style.display = 'block'; icon.textContent = 'â–¼'; }
  else { body.style.display = 'none'; icon.textContent = 'â–²'; }
}

// ================= LOGIC CORE =================
function getPairScore(t1, t2, isLimit5, isAlone2) {
  if(isLimit5) {
    let bonus = isAlone2 ? -500 : -200;
    let score = 0;
    if(t1 === 'D') score += bonus;
    if(t2 === 'D') score += bonus;
    return score;
  }
  
  if (!t1 && !t2) return 0; 
  if (!t1 || !t2) {
    let single = t1 || t2;
    if(single === 'D') return -500000; 
    return 0; 
  }
  
  const p = [t1, t2].sort().join('');
  if (p === 'AH') return -2000; 
  if (p === 'DN') return 0;
  if (p === 'AD' || p === 'AN' || p === 'HN' || p === 'NN') return 100;
  if (p === 'AA' || p === 'HH' || p === 'DD') return 10000;
  if (p === 'DH') return 100000;
  return 1000;
}

function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    let j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function buildDeckData(state) {
  let pool = { A:0, N:0, D:0, H:0 }; let poolNames = { A:[], N:[], D:[], H:[] };
  for(let aName in state.arcanaCounts) {
    let type = state.arcanaPriorities[aName] || 'N'; pool[type] += state.arcanaCounts[aName];
    for(let i=0; i<state.arcanaCounts[aName]; i++) poolNames[type].push(aName);
  }
  let pairs = []; let unassignedSlots = [];
  MONSTER_DATA.forEach(m => {
    let count = state.monsterCounts[m.name] || 0; if(count === 0) return;
    let isB = (m.rank === 'B'); let isLimit5 = (m.limit === 5); let fixed = state.exceptionData[m.name] || [];
    let isAlone2 = (isLimit5 && count <= 2);
    
    for(let i=0; i<count; i+=2) {
      let slot1 = { mName: m.name, isB: isB, isLimit5: isLimit5, isAlone2: isAlone2, type: null, fixedName: null, idx: i };
      let slot2 = (i + 1 < count) ? { mName: m.name, isB: isB, isLimit5: isLimit5, isAlone2: isAlone2, type: null, fixedName: null, idx: i+1 } : null;
      if(fixed[i] && poolNames[state.arcanaPriorities[fixed[i]]].includes(fixed[i])) {
        slot1.fixedName = fixed[i]; slot1.type = state.arcanaPriorities[fixed[i]];
        pool[slot1.type]--; poolNames[slot1.type].splice(poolNames[slot1.type].indexOf(fixed[i]), 1);
      }
      if(slot2 && fixed[i+1] && poolNames[state.arcanaPriorities[fixed[i+1]]].includes(fixed[i+1])) {
        slot2.fixedName = fixed[i+1]; slot2.type = state.arcanaPriorities[fixed[i+1]];
        pool[slot2.type]--; poolNames[slot2.type].splice(poolNames[slot2.type].indexOf(fixed[i+1]), 1);
      }
      pairs.push([slot1, slot2]);
      if(!slot1.fixedName) unassignedSlots.push(slot1);
      if(slot2 && !slot2.fixedName) unassignedSlots.push(slot2);
    }
  });
  return { state, pool, poolNames, pairs, unassignedSlots };
}

function dfsBestScore(pairs, pool) {
  let pairsFp = pairs.map(p => (p[0].type||'X') + (p[1] ? (p[1].type||'X') : '')).join('');
  
  function solve(pairIdx, curA, curN, curD, curH) {
    if (pairIdx === pairs.length) return { score: 0, assignment: [] };
    let key = `${pairsFp}_${pairIdx}_${curA}_${curN}_${curD}_${curH}`;
    if (globalMemo[key] !== undefined) return globalMemo[key];

    let p1 = pairs[pairIdx][0], p2 = pairs[pairIdx][1];
    let isB = p1.isB; let isLim5 = p1.isLimit5; let isAlone2 = p1.isAlone2;
    let curPool = { A: curA, N: curN, D: curD, H: curH };
    let cands = [];
    const canUse = (t) => { return !(isB && t === 'A'); };
    const canPair = (t1, t2) => {
      if(isLim5) return true; 
      if(t1 === 'D' && t2 === 'H') return false;
      if(t1 === 'H' && t2 === 'D') return false;
      return true;
    };

    if (p2 === null) {
      if (p1.type !== null) cands.push([p1.type, null]);
      else ['A','N','D','H'].forEach(t => { if (curPool[t] > 0 && canUse(t)) cands.push([t, null]); });
    } else {
      if (p1.type !== null && p2.type !== null) cands.push([p1.type, p2.type]);
      else if (p1.type !== null && p2.type === null) {
        ['A','N','D','H'].forEach(t => { if (curPool[t] > 0 && canUse(t) && canPair(p1.type, t)) cands.push([p1.type, t]); });
      } else if (p1.type === null && p2.type !== null) {
        ['A','N','D','H'].forEach(t => { if (curPool[t] > 0 && canUse(t) && canPair(t, p2.type)) cands.push([t, p2.type]); });
      } else {
        let types = ['A','N','D','H'];
        for(let i=0; i<4; i++) {
          for(let j=i; j<4; j++) {
            let t1 = types[i], t2 = types[j];
            if (!canUse(t1) || !canUse(t2)) continue;
            if (!canPair(t1, t2)) continue;
            if (t1 === t2) { if (curPool[t1] >= 2) cands.push([t1, t2]); }
            else { if (curPool[t1] >= 1 && curPool[t2] >= 1) cands.push([t1, t2]); }
          }
        }
      }
    }

    let bestScore = Infinity; let bestAssign = null;
    for (let c of cands) {
      let cost1 = (p1.type === null) ? c[0] : null; let cost2 = (p2 !== null && p2.type === null) ? c[1] : null;
      if (cost1) curPool[cost1]--; if (cost2) curPool[cost2]--;
      
      let res = solve(pairIdx + 1, curPool.A, curPool.N, curPool.D, curPool.H);
      if (res.score !== Infinity) {
        let total = getPairScore(c[0], c[1], isLim5, isAlone2) + res.score;
        if (total < bestScore) { bestScore = total; bestAssign = [c].concat(res.assignment); }
      }
      
      if (cost1) curPool[cost1]++; if (cost2) curPool[cost2]++;
    }
    globalMemo[key] = { score: bestScore, assignment: bestAssign };
    return globalMemo[key];
  }
  return solve(0, pool.A, pool.N, pool.D, pool.H);
}

function optimizeSingleDeckDummy(dd, useRandom) {
  let bNeed = 0; dd.unassignedSlots.forEach(s => { if(s.isB) bNeed++; });
  if(bNeed > (dd.pool['N'] + dd.pool['D'] + dd.pool['H'])) return { error: true };

  let res = dfsBestScore(dd.pairs, dd.pool);
  if(res.score === Infinity || !res.assignment) return { error: true };

  if(useRandom) {
    for(let t in dd.poolNames) shuffleArray(dd.poolNames[t]);
  }

  let resMap = {};
  for(let i=0; i<dd.pairs.length; i++) {
    let p1 = dd.pairs[i][0], p2 = dd.pairs[i][1]; let t1 = res.assignment[i][0], t2 = res.assignment[i][1];
    if(!resMap[p1.mName]) resMap[p1.mName] = [];
    resMap[p1.mName][p1.idx] = p1.fixedName ? p1.fixedName : dd.poolNames[t1].pop();
    if(p2) {
      if(!resMap[p2.mName]) resMap[p2.mName] = [];
      resMap[p2.mName][p2.idx] = p2.fixedName ? p2.fixedName : dd.poolNames[t2].pop();
    }
  }
  return { error: false, map: resMap, score: res.score };
}

// ================= RUN UI =================
async function runSingleOptimizeUI() {
  const c = document.getElementById('result-content'); c.innerHTML = '<div class="loading">ãƒ‡ãƒƒã‚­ä½œæˆä¸­...</div>';
  await sleep(10);
  
  let bestResult = null;
  let bestScore = Infinity;

  for(let i=0; i<50; i++) {
    globalMemo = {}; 
    let dd = buildDeckData(appState); 
    let res = optimizeSingleDeckDummy(dd, true); 
    if(!res.error && res.score < bestScore) {
      bestScore = res.score;
      bestResult = res;
    }
  }

  if(!bestResult) { 
    c.innerHTML = `<span style="color:red; font-weight:bold;">ã‚¨ãƒ©ãƒ¼: ç¦æ­¢ãƒ«ãƒ¼ãƒ«ï¼ˆH+Dãªã©ï¼‰ã‚’å›é¿ã§ãã‚‹çµ„ã¿åˆã‚ã›ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚<br>æ‰‹æŒã¡ã®ã‚«ãƒ¼ãƒ‰æšæ•°ã‚„å›ºå®šè¨­å®šã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚</span>`; 
    return; 
  }
  
  appState.optimizedResult = {}; 
  for(let m in bestResult.map) appState.optimizedResult[m] = bestResult.map[m].filter(x=>x); 
  
  saveData();
  renderResult(appState.optimizedResult, c, appState);
}

function renderResult(map, container, state) {
  let html = '<table><thead><tr><th>ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼</th><th>æ§‹æˆ</th></tr></thead><tbody>';
  MONSTER_DATA.forEach(m => {
    if(map[m.name]) {
      let sortedCards = [...map[m.name]].sort((a, b) => {
        return ARCANA_DATA.findIndex(x=>x.name===a) - ARCANA_DATA.findIndex(x=>x.name===b);
      });
      let badges = sortedCards.map(name => `<span class="res-card res-${state.arcanaPriorities[name]||'N'}">${name}</span>`).join('');
      html += `<tr><td><b>${m.name}</b> <span class="rank-badge rk-${m.rank}">${m.rank}</span></td><td>${badges}</td></tr>`;
    }
  });
  container.innerHTML = html + '</tbody></table>';
}

function renderCardList(needsMap, container, title) {
  let totalCards = 0;
  for(let mName in needsMap) {
    totalCards += Object.values(needsMap[mName]).reduce((a, b) => a + b, 0);
  }

  let limitWarningHtml = '';
  if (totalCards > 140) {
    limitWarningHtml = `<div style="color:#c62828; font-weight:bold; margin-bottom:10px; padding:8px; background:#ffebee; border:1px solid #ef5350; border-radius:4px;">
      âš ï¸ å¿…è¦æšæ•°ã®åˆè¨ˆãŒ ${totalCards} æšã¨ãªã‚Šã€ã‚²ãƒ¼ãƒ å†…ã®ã‚¿ãƒ­ãƒƒãƒˆæ‰€æŒä¸Šé™ï¼ˆæœ€å¤§140æšï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚<br>
      è¤‡æ•°ã®ãƒ‡ãƒƒã‚­ã§åŒã˜ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãƒ»ã‚¢ãƒ«ã‚«ãƒŠã®çµ„ã¿åˆã‚ã›ã‚’ä½¿ã„å›ã›ã‚‹ã‚ˆã†ã«ã€æ§‹æˆã‚’è¦‹ç›´ã™ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚
    </div>`;
  }

  let html = limitWarningHtml + `<div style="background:#fff; border:2px solid #ddd; border-radius:6px; padding:15px;"><h3 style="margin-top:0; color:#2E7D32;">${title} <span style="font-size:12px; color:#555; font-weight:normal;">(åˆè¨ˆ: ${totalCards}æš)</span></h3>`;
  const finalSorted = Object.keys(needsMap).sort((a,b) => getWeight(b) - getWeight(a));
  
  const arcanaOrder = {};
  ARCANA_DATA.forEach((a, idx) => { arcanaOrder[a.name] = idx; });

  finalSorted.forEach(m => {
    let cardsHtml = ''; 
    let sortedArcanas = Object.keys(needsMap[m]).sort((a, b) => arcanaOrder[a] - arcanaOrder[b]);
    for(let c of sortedArcanas) {
      cardsHtml += `<span class="res-card" style="background:${getArcanaColor(c)}; font-size:12px;">${c} x${needsMap[m][c]}</span>`;
    }
    html += `<div class="opt-res-row"><div class="opt-res-mon">${m}</div><div>${cardsHtml}</div></div>`;
  }); 
  html += '</div>'; 
  container.innerHTML += html;
}

async function calculateNeedsOnly() {
  const output = document.getElementById('global-result');
  if(savedDecks.length === 0) { output.innerHTML = '<span style="color:red; font-weight:bold;">ä¿å­˜ãƒ‡ãƒƒã‚­ãŒã‚ã‚Šã¾ã›ã‚“</span>'; return; }
  
  let finalGlobalNeeds = {};
  let activeCount = 0;
  let hasError = false;
  let errorDecks = [];
  
  output.innerHTML = '<div class="loading">å¿…è¦æšæ•°ã‚’ç®—å‡ºä¸­...</div>';
  await sleep(10);
  globalMemo = {};

  try {
    for(let i=0; i<savedDecks.length; i++) {
      let d = savedDecks[i];
      if(d.active === false) continue; 
      activeCount++;
      
      let resMap = d.state.optimizedResult;
      if(!resMap || Object.keys(resMap).length === 0) {
        try {
          let dd = buildDeckData(d.state);
          let res = optimizeSingleDeckDummy(dd, false);
          if(res.error) { hasError = true; errorDecks.push(d.name); continue; }
          let cleanedMap = {};
          for(let m in res.map) cleanedMap[m] = res.map[m].filter(x=>x);
          resMap = cleanedMap;
        } catch(e) { hasError = true; errorDecks.push(d.name); continue; }
      }
      
      for(let mName in resMap) {
        if(!finalGlobalNeeds[mName]) finalGlobalNeeds[mName] = {}; let localCounts = {};
        resMap[mName].forEach(c => localCounts[c] = (localCounts[c]||0)+1);
        for(let c in localCounts) finalGlobalNeeds[mName][c] = Math.max(finalGlobalNeeds[mName][c] || 0, localCounts[c]);
      }
    }
  } catch(e) { hasError = true; }

  if(activeCount === 0) { output.innerHTML = '<span style="color:red; font-weight:bold;">æœ‰åŠ¹ãªãƒ‡ãƒƒã‚­ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</span>'; return; }
  if(hasError) { 
    output.innerHTML = `<span style="color:red; font-weight:bold;">ä¸€éƒ¨ã®ãƒ‡ãƒƒã‚­ã«ç¦æ­¢ãƒ«ãƒ¼ãƒ«ã‚’å›é¿ã§ããªã„æ§‹æˆãŒã‚ã‚Šã¾ã™ã€‚æ‰‹å‹•ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br>ï¼ˆå¯¾è±¡: ${errorDecks.join(', ')}ï¼‰</span>`; 
    return; 
  }
  if(Object.keys(finalGlobalNeeds).length === 0) { output.innerHTML = '<span style="color:red; font-weight:bold;">è¨ˆç®—çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚</span>'; return; }
  
  output.innerHTML = '';
  renderCardList(finalGlobalNeeds, output, "ğŸ“Š ç¾åœ¨ã®å¿…è¦ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ (æœ€é©åŒ–é©ç”¨çŠ¶æ³)");
}

// ----------------------------------------------------
// ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ»è‡ªå‹•ç·©å’Œæœ€é©åŒ–ãƒ­ã‚¸ãƒƒã‚¯ (v5.9 æœ€çµ‚ç‰ˆ)
// ----------------------------------------------------
async function runHybridOptimization(isDeepSearch = false) {
  const output = document.getElementById('global-result');
  if(savedDecks.length === 0) { output.innerHTML = '<span style="color:red; font-weight:bold;">ä¿å­˜ãƒ‡ãƒƒã‚­ãŒã‚ã‚Šã¾ã›ã‚“</span>'; return; }
  
  let activeIndices = [];
  savedDecks.forEach((d, i) => { if(d.active !== false) activeIndices.push(i); });
  if(activeIndices.length === 0) { output.innerHTML = '<span style="color:red; font-weight:bold;">æœ‰åŠ¹ãªãƒ‡ãƒƒã‚­ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</span>'; return; }
  
  backupDecks = JSON.parse(JSON.stringify(savedDecks));
  output.innerHTML = `<div class="loading">${isDeepSearch ? 'ğŸ¤” ç†Ÿè€ƒãƒ¢ãƒ¼ãƒ‰ã§' : ''}æœ€é©åŒ–è¨ˆç®—ã‚’å®Ÿè¡Œä¸­...<br><span id="sim-progress" style="font-size:11px; font-weight:normal;"></span></div>`;
  await sleep(10);
  
  globalMemo = {}; 
  let initialBestScores = [];
  for(let i=0; i<activeIndices.length; i++) {
    let idx = activeIndices[i];
    let dd = buildDeckData(savedDecks[idx].state);
    let res = dfsBestScore(dd.pairs, dd.pool);
    if(res.score === Infinity) { output.innerHTML = `<span style="color:red; font-weight:bold;">ãƒ‡ãƒƒã‚­ã€Œ${savedDecks[idx].name}ã€ã®ã‚¨ãƒ©ãƒ¼: å›é¿ä¸èƒ½ã§ã™ã€‚</span>`; return; }
    initialBestScores.push(res.score);
  }

  let mSet = new Set();
  activeIndices.forEach(idx => { let dd = buildDeckData(savedDecks[idx].state); dd.unassignedSlots.forEach(s => mSet.add(s.mName)); });
  let allUsedMonsters = Array.from(mSet);
  
  let globalMonsterCounts = {};
  activeIndices.forEach(idx => {
    let dd = buildDeckData(savedDecks[idx].state);
    dd.unassignedSlots.forEach(s => { globalMonsterCounts[s.mName] = (globalMonsterCounts[s.mName] || 0) + 1; });
  });

  let hasLimit = Object.values(rareStockLimits).some(v => v > 0);
  let maxAllowance = hasLimit ? 10 : 0; 
  
  let overallBestResult = null;
  let overallBestScore = Infinity;

  let maxLoop0 = isDeepSearch ? 3000 : 100;
  let maxLoopN = isDeepSearch ? 1500 : 100;

  for(let allowance = 0; allowance <= maxAllowance; allowance++) {
    let currentLimits = {};
    let baseAllowance = Math.floor(allowance / 2);
    let extraAllowanceFor50k = (allowance % 2 !== 0) ? 1 : 0;

    for(let k in rareStockLimits) {
      if(rareStockLimits[k] > 0) {
        let w = getWeight(k);
        if (w === 50000) {
          currentLimits[k] = rareStockLimits[k] + baseAllowance + extraAllowanceFor50k;
        } else {
          currentLimits[k] = rareStockLimits[k] + baseAllowance;
        }
      } else {
        currentLimits[k] = 0;
      }
    }

    let processOrder = allUsedMonsters.sort((a,b) => {
      let lA = currentLimits[a] || 0;
      let lB = currentLimits[b] || 0;
      if (lA > 0 && lB === 0) return -1;
      if (lB > 0 && lA === 0) return 1;
      if (lA > 0 && lB > 0) {
        if (lA !== lB) return lA - lB; 
      }
      let wA = getWeight(a), wB = getWeight(b);
      if (wA !== wB) return wB - wA;
      return (globalMonsterCounts[b] || 0) - (globalMonsterCounts[a] || 0);
    });

    let bestResultForAllowance = null;
    let bestScoreForAllowance = Infinity;

    let loops = allowance === 0 ? maxLoop0 : maxLoopN;

    for(let i=0; i<=loops; i++) {
      if(i % 10 === 0) {
        let pEl = document.getElementById('sim-progress');
        if(pEl) pEl.textContent = `ï¼ˆç·©å’Œãƒ¬ãƒ™ãƒ« ${allowance} : æ¤œç´¢ ${i}/${loops}ï¼‰`;
        await sleep(0);
      }
      
      let useRandom = (i > 0);
      let simDecks = activeIndices.map((origIdx, k) => {
        let dd = buildDeckData(savedDecks[origIdx].state); dd.bestScore = initialBestScores[k]; return dd;
      });

      let currentOrder = [...processOrder];
      if(useRandom) {
         currentOrder.sort((a,b) => {
           let lA = currentLimits[a] || 0;
           let lB = currentLimits[b] || 0;
           if(lA > 0 && lB > 0 && lA === lB) return Math.random() - 0.5;
           if(lA === 0 && lB === 0 && getWeight(a) === getWeight(b)) return Math.random() - 0.5;
           return 0;
         });
      }

      for(let mName of currentOrder) {
        let maxNeeded = Math.max(...simDecks.map(dd => dd.unassignedSlots.filter(s => s.mName === mName).length));
        if(maxNeeded === 0) continue;
        
        for(let slotIdx = 0; slotIdx < maxNeeded; slotIdx++) {
          let targetDecks = simDecks.filter(dd => dd.unassignedSlots.filter(s => s.mName === mName).length > slotIdx);
          if(targetDecks.length === 0) continue;
          
          let arcanaFreq = {};
          targetDecks.forEach(dd => {
            let uniqueArcs = new Set();
            for(let type in dd.poolNames) dd.poolNames[type].forEach(a => uniqueArcs.add(a));
            uniqueArcs.forEach(a => { arcanaFreq[a] = (arcanaFreq[a] || 0) + 1; });
          });
          
          let candidates = Object.keys(arcanaFreq).sort((a,b) => {
            if(useRandom && arcanaFreq[b] === arcanaFreq[a]) return Math.random() - 0.5;
            return arcanaFreq[b] - arcanaFreq[a];
          });
          
          let bestCand = null; let maxApp = -1;
          for(let cand of candidates) {
            let appDecks = []; let type = savedDecks[activeIndices[0]].state.arcanaPriorities[cand];
            for(let j=0; j<targetDecks.length; j++) {
              let dd = targetDecks[j];
              if(!dd.poolNames[type].includes(cand)) continue;
              let slot = dd.unassignedSlots.filter(s => s.mName === mName)[slotIdx];
              if(slot.isB && type === 'A') continue;
              
              slot.fixedName = cand; slot.type = type; dd.pool[type]--;
              let tRes = dfsBestScore(dd.pairs, dd.pool);
              if(tRes.score <= dd.bestScore) appDecks.push(dd);
              slot.fixedName = null; slot.type = null; dd.pool[type]++;
            }
            if(appDecks.length > maxApp) { maxApp = appDecks.length; bestCand = {name:cand, type:type, decks:appDecks}; }
            if(maxApp === targetDecks.length) break;
          }
          
          if(bestCand) {
            bestCand.decks.forEach(dd => {
              let slot = dd.unassignedSlots.filter(s => s.mName === mName)[slotIdx];
              slot.fixedName = bestCand.name; slot.type = bestCand.type;
              dd.pool[bestCand.type]--; dd.poolNames[bestCand.type].splice(dd.poolNames[bestCand.type].indexOf(bestCand.name), 1);
            });
          }
        }
      }
      
      let resultMaps = [];
      let isValid = true;
      simDecks.forEach(dd => {
        let res = optimizeSingleDeckDummy(dd, useRandom);
        if(res.error) { isValid = false; return; }
        
        let cleanedMap = {};
        for(let m in res.map) cleanedMap[m] = res.map[m].filter(x=>x);
        resultMaps.push(cleanedMap);
      });
      if(!isValid) continue;

      let needs = {};
      resultMaps.forEach(map => {
        for(let m in map) {
          if(!needs[m]) needs[m] = {}; let lc = {};
          map[m].forEach(c => lc[c]=(lc[c]||0)+1);
          for(let c in lc) needs[m][c] = Math.max(needs[m][c]||0, lc[c]);
        }
      });
      
      let rawCost = 0;
      let penalty = 0;
      for(let m in needs) {
        let count = Object.values(needs[m]).reduce((a,b)=>a+b,0);
        rawCost += getWeight(m) * count;
        let lim = currentLimits[m];
        if(lim && lim > 0 && count > lim) {
          penalty += (count - lim) * 1000000;
        }
      }
      
      let totalScore = rawCost + penalty;
      
      if(totalScore < bestScoreForAllowance) {
        bestScoreForAllowance = totalScore;
        bestResultForAllowance = { maps: resultMaps, needs: needs, penalty: penalty };
      }
    } 
    
    if (bestResultForAllowance && bestResultForAllowance.penalty === 0) {
      overallBestResult = bestResultForAllowance;
      break;
    } else {
      if (!overallBestResult || bestScoreForAllowance < overallBestScore) {
        overallBestResult = bestResultForAllowance;
        overallBestScore = bestScoreForAllowance;
      }
    }
  } 

  if(!overallBestResult) { output.innerHTML = '<span style="color:red; font-weight:bold;">æœ€é©åŒ–å¤±æ•—</span>'; return; }
  
  activeIndices.forEach((origIdx, i) => { 
    savedDecks[origIdx].state.optimizedResult = overallBestResult.maps[i]; 
  });
  localStorage.setItem(STORAGE_KEY_DECKS, JSON.stringify(savedDecks));
  renderDeckList();
  
  let warningHtml = '';
  let finalNeeds = overallBestResult.needs;
  for(let mName in finalNeeds) {
    let limit = rareStockLimits[mName];
    if(limit && limit > 0) {
      let total = Object.values(finalNeeds[mName]).reduce((a,b)=>a+b,0);
      if(total > limit) {
        warningHtml += `<div style="color:#c62828; font-weight:bold; margin-bottom:5px;">âš ï¸ ${mName}: å¿…è¦æ•°${total} (æ‰€æŒ${limit}) - è¶³ã‚Šã¾ã›ã‚“ï¼æ‰€æŒæ•°ã‚’ä¸€æ™‚çš„ã«å¢—ã‚„ã—ã¦è¨ˆç®—ã—ã¾ã—ãŸã€‚</div>`;
      }
    }
  }
  
  output.innerHTML = warningHtml;
  renderCardList(finalNeeds, output, "ğŸ´ æœ€é©åŒ–å®Œäº†: å¿…è¦ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ");
}

// ================= EXPORT / IMPORT =================
function exportData() {
  const data = { state: appState, decks: savedDecks, stocks: rareStockLimits };
  try {
    const shortObj = { 
      s: { a: data.state.arcanaCounts, p: data.state.arcanaPriorities, m: data.state.monsterCounts, e: data.state.exceptionData }, 
      d: data.decks.map(d => ({ n: d.name, a: d.state.arcanaCounts, p: d.state.arcanaPriorities, m: d.state.monsterCounts, e: d.state.exceptionData, o: d.state.optimizedResult, act: d.active })),
      k: data.stocks
    };
    const compressed = btoa(unescape(encodeURIComponent(JSON.stringify(shortObj))));
    document.getElementById('io-data').value = compressed;
    alert("ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã—ã¾ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
  } catch(e) { alert("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
}

function importData() {
  const text = document.getElementById('io-data').value.trim();
  if(!text) { alert("ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"); return; }
  try {
    const shortObj = JSON.parse(decodeURIComponent(escape(atob(text))));
    appState = { arcanaCounts: shortObj.s.a||{}, arcanaPriorities: shortObj.s.p||{}, monsterCounts: shortObj.s.m||{}, exceptionData: shortObj.s.e||{}, optimizedResult: {} };
    savedDecks = shortObj.d.map(d => ({ name: d.n, active: d.act !== false, state: { arcanaCounts: d.a||{}, arcanaPriorities: d.p||{}, monsterCounts: d.m||{}, exceptionData: d.e||{}, optimizedResult: d.o||{} } }));
    if(shortObj.k) rareStockLimits = shortObj.k;
    
    if(!confirm("ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ã™ã¹ã¦ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    saveData(); 
    localStorage.setItem(STORAGE_KEY_DECKS, JSON.stringify(savedDecks)); 
    localStorage.setItem(STORAGE_KEY_STOCKS, JSON.stringify(rareStockLimits));
    renderAll();
    renderStockSettings();
    alert("ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸã€‚");
  } catch(e) { alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: æ­£ã—ã„ãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"); }
}

// ================= STORAGE =================
function toggleDeckActive(i) {
  savedDecks[i].active = (savedDecks[i].active === false) ? true : false;
  localStorage.setItem(STORAGE_KEY_DECKS, JSON.stringify(savedDecks));
  renderDeckList();
}

function renderDeckList() {
  const c = document.getElementById('deck-list-container'); c.innerHTML = '';
  savedDecks.forEach((d, i) => {
    let isActive = d.active !== false;
    const item = document.createElement('div'); 
    item.className = 'deck-item' + (isActive ? '' : ' inactive'); 
    let contentHtml = '';
    if(d.state.optimizedResult && Object.keys(d.state.optimizedResult).length > 0) {
      for(let m in d.state.optimizedResult) {
        let sortedCards = [...d.state.optimizedResult[m]].sort((a, b) => {
          return ARCANA_DATA.findIndex(x=>x.name===a) - ARCANA_DATA.findIndex(x=>x.name===b);
        });
        let cards = sortedCards.map(name => `<span class="res-card res-${d.state.arcanaPriorities[name]||'N'}" style="font-weight:normal;">${name}</span>`).join('');
        contentHtml += `<div class="opt-res-row"><div class="opt-res-mon">${m}</div><div>${cards}</div></div>`;
      }
    } else contentHtml = '<span style="color:#999; font-weight:bold;">æ§‹æˆãŒã¾ã ä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</span>';
    
    let activeBtnHtml = `<button class="btn-active-toggle ${isActive ? 'btn-active-on' : 'btn-active-off'}" onclick="event.stopPropagation(); toggleDeckActive(${i})">${isActive ? 'âœ… æœ‰åŠ¹' : 'ğŸš« ç„¡åŠ¹'}</button>`;
    
    item.innerHTML = `<div class="deck-header" onclick="toggleDeck(${i})">
      <div style="display:flex; align-items:center;">
        ${activeBtnHtml}
        <span class="deck-name" style="${isActive ? '' : 'text-decoration:line-through;'}">${d.name}</span>
      </div>
      <div><button onclick="event.stopPropagation(); loadDeck(${i})" style="padding:6px 10px; cursor:pointer; background:#e3f2fd; border:1px solid #90caf9; border-radius:4px; font-weight:bold; color:#1565c0;">èª­è¾¼</button>
      <button onclick="event.stopPropagation(); deleteDeck(${i})" style="padding:6px 10px; background:#c62828; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:bold; margin-left:4px;">å‰Šé™¤</button></div></div>
      <div id="deck-body-${i}" class="deck-body">${contentHtml}</div>`; c.appendChild(item);
  });
}
function toggleDeck(i) { document.getElementById(`deck-body-${i}`).classList.toggle('open'); }
function saveCurrentDeck() {
  const name = document.getElementById('deck-name-input').value || `ãƒã‚¤ãƒ‡ãƒƒã‚­ ${savedDecks.length+1}`;
  savedDecks.push({ name: name, active: true, state: JSON.parse(JSON.stringify(appState)) }); localStorage.setItem(STORAGE_KEY_DECKS, JSON.stringify(savedDecks)); renderDeckList(); document.getElementById('deck-name-input').value = '';
}
function loadDeck(i) { if(!confirm(`ã€Œ${savedDecks[i].name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ`)) return; appState = JSON.parse(JSON.stringify(savedDecks[i].state)); saveData(); renderAll(); switchTab('arcana'); }
function deleteDeck(i) { if(!confirm(`å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return; savedDecks.splice(i, 1); localStorage.setItem(STORAGE_KEY_DECKS, JSON.stringify(savedDecks)); renderDeckList(); }
function switchTab(id) { 
  activeTabId = id;
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active')); 
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
  document.getElementById('panel-' + id).classList.add('active'); 
  document.querySelector(`button[onclick="switchTab('${id}')"]`).classList.add('active'); 
  if(id === 'exception') renderException(); 
  if(id === 'storage') renderDeckList(); 
  updateStats();
}
</script>
</body>
</html>
