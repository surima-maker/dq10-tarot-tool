<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DQ10 ã‚¿ãƒ­ãƒƒãƒˆãƒ‡ãƒƒã‚­ä¾¿åˆ©ãƒ„ãƒ¼ãƒ«</title>
<meta name="description" content="ãƒ‰ãƒ©ã‚´ãƒ³ã‚¯ã‚¨ã‚¹ãƒˆXï¼ˆDQ10ï¼‰ã®å ã„å¸«ç”¨ã‚¿ãƒ­ãƒƒãƒˆãƒ‡ãƒƒã‚­ã‚’æœ€é©åŒ–ã™ã‚‹ä¾¿åˆ©ãƒ„ãƒ¼ãƒ«ã€‚è¤‡æ•°ãƒ‡ãƒƒã‚­ã®ä¸€æ‹¬æœ€é©åŒ–ã€å¿…è¦ã‚«ãƒ¼ãƒ‰æšæ•°ã®æœ€å°åŒ–ã€ã‚ªãƒ¼ãƒ©ç™ºç”Ÿç‡ã‚’è€ƒæ…®ã—ãŸè‡ªå‹•æ§‹æˆãªã©ãŒå¯èƒ½ã§ã™ã€‚">
<style>
  :root { --main-bg: #f4f4f9; --header-bg: #1a237e; --accent: #3949ab; --text: #333; --error: #c62828; --success: #2e7d32; }
  body { font-family: "Meiryo UI", sans-serif; margin: 0; padding: 0; background: var(--main-bg); color: var(--text); font-size: 13px; display: flex; flex-direction: column; min-height: 100vh; }
  
  header { background: var(--header-bg); color: #fff; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; }
  h1 { margin: 0; font-size: 16px; font-weight: bold; }
  
  .sticky-header { position: sticky; top: 0; z-index: 100; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  .tabs { display: flex; border-bottom: 1px solid #ddd; }
  .tab-btn { flex: 1; padding: 12px 5px; border: none; background: #f9f9f9; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; color: #666; font-size: 12px; transition: 0.2s; }
  .tab-btn.active { border-bottom-color: var(--accent); color: var(--accent); background: #fff; }
  .tab-btn:hover { background: #eee; }

  .global-stats { display: flex; font-size: 14px; font-weight: bold; border-bottom: 1px solid #ddd; background: #e8eaf6; }
  .stat-box { flex: 1; padding: 10px; text-align: center; transition: 0.3s; }
  .stat-box.ok { background-color: #c8e6c9; color: #1b5e20; }
  
  .warning-bar { background: var(--error); color: #fff; padding: 8px; text-align: center; font-size: 12px; display: none; font-weight:bold; }

  .container { max-width: 800px; margin: 0 auto; padding: 15px; flex: 1; }
  .panel { display: none; animation: fadeIn 0.2s; }
  .panel.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 6px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; }
  th { background: #e0e0e0; padding: 8px; font-size: 11px; text-align: center; color: #555; }
  td { padding: 6px 8px; border-bottom: 1px solid #eee; vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  
  .click-row { cursor: pointer; transition: background-color 0.2s; }
  .click-row:hover { filter: brightness(0.95); }
  .desc-row td { background: #fafafa; font-size: 11px; color: #555; padding: 8px 15px; border-bottom: 2px solid #ddd; }

  .btn-count { width: 30px; height: 30px; border: none; border-radius: 4px; color: #fff; font-weight: bold; cursor: pointer; font-size: 16px; display:inline-flex; align-items:center; justify-content:center; }
  .btn-minus { background: #7B1FA2; }
  .btn-plus { background: #2E7D32; }
  .val-display { display: inline-block; width: 30px; text-align: center; font-weight: bold; font-size: 15px; }
  
  .btn-reset { background: #d32f2f; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-bottom: 10px; }
  .btn-primary { width: 100%; padding: 14px; background: var(--header-bg); color: #fff; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; transition:0.2s; }
  .btn-primary:hover { background: #283593; }
  .btn-primary:disabled { background: #ccc; cursor: not-allowed; }

  .prio-group { display: flex; gap: 3px; justify-content: center; }
  .prio-btn { width: 28px; height: 24px; border: 1px solid #ccc; background: #fff; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: bold; color: #bbb; }
  .prio-btn.active-H { background: #1976d2; color: #fff; border-color:#1565c0; }
  .prio-btn.active-A { background: #d32f2f; color: #fff; border-color:#b71c1c; }
  .prio-btn.active-N { background: #43A047; color: #fff; border-color:#2e7d32; }
  .prio-btn.active-D { background: #FDD835; color: #333; border-color:#fbc02d; }

  .rank-badge { color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; display: inline-block; width: 30px; text-align: center; }
  .rk-SSS { background: #880e4f; } .rk-SS { background: #bf360c; } .rk-S { background: #e65100; } .rk-A { background: #1565c0; } .rk-B { background: #4e342e; }

  .res-card { display: inline-block; padding: 3px 6px; margin: 2px; border-radius: 4px; font-size: 11px; width: 65px; text-align: center; border:1px solid rgba(0,0,0,0.1); font-weight:bold; }
  .res-H { background: #BBDEFB; color: #0D47A1; }
  .res-A { background: #ffcdd2; color: #b71c1c; } 
  .res-N { background: #C8E6C9; color: #1B5E20; } 
  .res-D { background: #FFF9C4; color: #F57F17; } 

  .deck-item { background: #fff; border: 1px solid #ddd; margin-bottom: 8px; border-radius: 6px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
  .deck-header { padding: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: #fff; transition:0.2s; }
  .deck-header:hover { background: #f5f5f5; }
  .deck-name { font-weight: bold; color: var(--header-bg); font-size:14px; }
  .deck-body { display: none; padding: 15px; background: #fafafa; border-top: 1px solid #eee; font-size: 12px; }
  .deck-body.open { display: block; }
  .opt-res-row { display:flex; margin-bottom:5px; align-items: baseline; border-bottom:1px dashed #eee; padding-bottom:3px; }
  .opt-res-mon { font-weight: bold; width:130px; color:#444; }
  .save-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size:14px; }

  .info-box { background:#e3f2fd; padding:10px; border-radius:6px; margin-bottom:15px; font-size:12px; border-left:5px solid #1976d2; line-height:1.5; }
  .ex-tag { background: #ff9800; color: #fff; font-size: 10px; padding: 1px 4px; border-radius: 3px; margin-top: 2px; display:inline-block; }
  .loading { font-size: 14px; font-weight: bold; color: #ef6c00; padding: 20px; text-align: center; animation: blink 1s infinite; }
  @keyframes blink { 50% { opacity: 0.5; } }
  .action-buttons { display: flex; gap: 10px; margin-top: 15px; }
  
  /* ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆå¼•ç”¨å…ƒï¼‰ */
  footer { background: #e0e0e0; color: #555; text-align: center; padding: 15px; font-size: 11px; margin-top: auto; }
  footer a { color: #3949ab; text-decoration: none; }
  footer a:hover { text-decoration: underline; }
</style>
</head>
<body>

<header>
  <h1>ğŸ”® DQ10 ã‚¿ãƒ­ãƒƒãƒˆãƒ‡ãƒƒã‚­ä¾¿åˆ©ãƒ„ãƒ¼ãƒ«</h1>
</header>

<div class="sticky-header">
  <div id="warning-msg" class="warning-bar">âš ï¸ ã‚¢ãƒ«ã‚«ãƒŠã¨ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®åˆè¨ˆã‚’ãã‚Œãã‚Œ20æšã«ã—ã¦ãã ã•ã„</div>
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('arcana')">1. ã‚¢ãƒ«ã‚«ãƒŠ</button>
    <button class="tab-btn" onclick="switchTab('monster')">2. ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼</button>
    <button class="tab-btn" onclick="switchTab('exception')">3. ã‚¢ãƒ«ã‚«ãƒŠå›ºå®šã‚«ãƒ¼ãƒ‰é¸æŠ</button>
    <button class="tab-btn" onclick="switchTab('result')">4. ãƒ‡ãƒƒã‚­ä½œæˆ</button>
    <button class="tab-btn" onclick="switchTab('storage')">5. ãƒ‡ãƒƒã‚­ä¿å­˜/å¿…è¦ã‚«ãƒ¼ãƒ‰ç®—å‡º/æœ€é©åŒ–</button>
  </div>
  <div class="global-stats">
    <div id="stat-arc-container" class="stat-box">ã‚¢ãƒ«ã‚«ãƒŠ: <span id="stat-arc">0</span>/20</div>
    <div id="stat-mon-container" class="stat-box">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼: <span id="stat-mon">0</span>/20</div>
  </div>
</div>

<div class="container">
  
  <!-- TAB 1: Arcana -->
  <div id="panel-arcana" class="panel active">
    <div style="display:flex; justify-content: flex-end; align-items: center; margin-bottom: 10px;">
      <label style="margin-right: 10px; font-size: 12px; font-weight: bold; cursor: pointer;">
        <input type="checkbox" id="chk-reset-opt" checked> ã‚ªãƒ¼ãƒ©ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚‚åˆæœŸåŒ–
      </label>
      <button class="btn-reset" onclick="resetTab('arcana')" style="margin: 0;">ã“ã®ã‚¿ãƒ–ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    <div class="info-box">
      <b>ã‚ªãƒ¼ãƒ©ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦</b><br>
      æ‰‹æœ­ã§ã‚ªãƒ¼ãƒ©ã‚’ä½œã‚Šã‚„ã™ãã™ã‚‹ãŸã‚ã®è¨­å®šã§ã™ã€‚<br>
      Aã¨Hã‚’å„ªå…ˆçš„ã«çµ„ã¾ã›ã€Dã¨Hã‚’ã§ãã‚‹é™ã‚Šæ¸›ã‚‰ã™ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ¨å¥¨ã®è¨­å®šã§ã™ã€‚è‡ªç”±ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚<br><br>
      <b>H</b> (Hand): æ‰‹æœ­ã«æ®‹ã‚Šã‚„ã™ã„ãƒ»ä½é »åº¦ä½¿ç”¨<br>
      <b>A</b> (Aura): ã‚ªãƒ¼ãƒ©æ¨å¥¨<br>
      <b>N</b> (Normal): ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ»é«˜é »åº¦ä½¿ç”¨<br>
      <b>D</b> (Deprecated): ã‚ªãƒ¼ãƒ©éæ¨å¥¨ï¼ˆã‚ªãƒ¼ãƒ©æ•™çš‡ã®ãƒªã‚¸ã‚§ãƒã¯æ•™çš‡ã§å»¶é•·ã§ããªã„ãŸã‚ï¼‰
    </div>
    <table id="tbl-arcana">
      <thead><tr><th>ã‚¢ãƒ«ã‚«ãƒŠ</th><th>æšæ•°</th><th>ã‚ªãƒ¼ãƒ©ã‚ªãƒ—ã‚·ãƒ§ãƒ³</th></tr></thead>
      <tbody id="tbody-arcana"></tbody>
    </table>
  </div>

  <!-- TAB 2: Monster -->
  <div id="panel-monster" class="panel">
    <div style="display:flow-root;"><button class="btn-reset" onclick="resetTab('monster')">ã“ã®ã‚¿ãƒ–ã‚’ãƒªã‚»ãƒƒãƒˆ</button></div>
    <div class="info-box">
      â€»ãã•ã£ãŸæ­»ä½“ä»¥å¤–ã®Bãƒ©ãƒ³ã‚¯ä»¥ä¸‹ã¯çœç•¥ã—ã¦ã„ã¾ã™ã€‚(å¿…è¦ãªå ´åˆã¯ä½¿ã‚ãªã„ã‚«ãƒ¼ãƒ‰ã§ä»®ç½®ãã—ã¦ãã ã•ã„ã€‚)<br>
      Bãƒ©ãƒ³ã‚¯ã®ãã•ã£ãŸæ­»ä½“ã«ã¯ã€æ”»æ’ƒç³»ã‚¢ãƒ«ã‚«ãƒŠã¯è‡ªå‹•ã§ã¯å‰²ã‚Šå½“ã¦ã¾ã›ã‚“ã€‚
    </div>
    <table id="tbl-monster"><tbody id="tbody-monster"></tbody></table>
  </div>

  <!-- TAB 3: Fixed -->
  <div id="panel-exception" class="panel">
    <div style="display:flow-root;"><button class="btn-reset" onclick="resetTab('exception')">ã“ã®ã‚¿ãƒ–ã‚’ãƒªã‚»ãƒƒãƒˆ</button></div>
    <div class="info-box">
      ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®ã‚¢ãƒ«ã‚«ãƒŠã‚’å›ºå®šã—ã¾ã™ã€‚æœªè¨­å®šã®å ´åˆè‡ªç”±ã«å‰²ã‚ŠæŒ¯ã‚‰ã‚Œã¾ã™ã€‚<br>
      ã‚«ãƒ¼ãƒ‰ã‚’æ¶ˆè²»ã—ãªã„åŠ¹æœã‚„ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ãŒä¸ŠãŒã‚‹åŠ¹æœãªã©æŒã¤ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã¯å›ºå®šã‚’æ¨å¥¨ã—ã¦ã„ã¾ã™ã€‚
    </div>
    <div id="exception-content"></div>
  </div>

  <!-- TAB 4: Result -->
  <div id="panel-result" class="panel">
    <button id="btn-run" class="btn-primary" onclick="runSingleOptimizeUI()">ğŸ”„ ãƒ‡ãƒƒã‚­ä½œæˆ</button>
    <div id="result-content" style="margin-top:20px;"></div>
  </div>

  <!-- TAB 5: Storage -->
  <div id="panel-storage" class="panel">
    <div class="info-box" style="background:#fff3e0; border-left-color:#ff9800;">
      <b>âš¡ ä¸€æ‹¬æœ€é©åŒ–æ©Ÿèƒ½</b><br>
      ã‚«ãƒ¼ãƒ‰æšæ•°ãŒæœ€ã‚‚å°‘ãªãæ¸ˆã‚€çµ„ã¿åˆã‚ã›ã«æœ€é©åŒ–ã—ã¾ã™ã€‚ãã‚‰ã‚„ã¿ãƒãƒ¼ãƒ”ãƒ¼ãªã©ã®ä¸€éƒ¨ã®ãƒ‘ãƒƒã‚¯ã‹ã‚‰ã—ã‹å‡ºãªã„ä½¿ç”¨é »åº¦ã®é«˜ã„ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’å„ªå…ˆçš„ã«è¨ˆç®—ã—ã¾ã™ã€‚<br>
      ã“ã®æ©Ÿèƒ½ã¯å…¥ã£ã¦ã„ã‚‹ã‚¢ãƒ«ã‚«ãƒŠã‚„ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®æšæ•°ã¯å¤‰æ›´ã›ãšã€ã‚ãã¾ã§å‰²ã‚Šå½“ã¦ã®ã¿ã‚’å¤‰æ›´ã—ã¾ã™ã€‚
    </div>
    
    <div style="margin-bottom:20px; display:flex; gap:10px;">
      <input type="text" id="deck-name-input" class="save-input" placeholder="ãƒ‡ãƒƒã‚­å (ä¾‹:æ±ç”¨ã€ä¸‡é­”ç”¨)">
      <button onclick="saveCurrentDeck()" style="padding:0 20px; background:var(--success); color:#fff; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">ä¿å­˜</button>
    </div>
    
    <div id="deck-list-container"></div>
    
    <div style="margin-top:30px; padding-top:20px; border-top:2px dashed #ccc;">
      <div class="action-buttons">
        <button class="btn-primary" style="background:#0288D1; flex:1;" onclick="calculateNeedsOnly()">ğŸ“Š å¿…è¦æšæ•°ã‚’ç®—å‡ºã™ã‚‹</button>
        <button class="btn-primary" style="background:#ef6c00; flex:2;" onclick="runGlobalOptimizationUI()">âš¡ è¤‡æ•°ã®ãƒ‡ãƒƒã‚­ã®å¿…è¦æšæ•°ã‚’æœ€é©åŒ–ã™ã‚‹</button>
        <button class="btn-primary" style="background:#757575; flex:1;" onclick="undoOptimization()">âª ä¸€å€‹å‰ã®çŠ¶æ…‹ã«æˆ»ã™</button>
      </div>
      <div id="global-result" style="margin-top:15px;"></div>
    </div>
    
    <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ -->
    <div style="margin-top:40px; padding-top:20px; border-top:2px dashed #ccc;">
      <b>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— (ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ)</b>
      <textarea id="io-data" class="save-input" style="width:100%; height:60px; margin-top:10px; font-size:11px; font-family:monospace; line-height:1.2; resize:vertical;" placeholder="ã“ã“ã«ãƒ‡ãƒ¼ã‚¿ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚å¾©å…ƒã™ã‚‹éš›ã‚‚ã“ã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚"></textarea>
      <div class="action-buttons" style="margin-top:8px;">
        <button class="btn-primary" style="background:#424242; flex:1; padding:10px;" onclick="exportData()">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã™ã‚‹</button>
        <button class="btn-primary" style="background:#424242; flex:1; padding:10px;" onclick="importData()">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã™ã‚‹</button>
      </div>
    </div>
  </div>

</div>

<!-- ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆå¼•ç”¨å…ƒè¡¨è¨˜ï¼‰ -->
<footer>
  â€»æœ¬ãƒ„ãƒ¼ãƒ«ã®ã‚¢ãƒ«ã‚«ãƒŠãŠã‚ˆã³ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®åŠ¹æœãƒ‡ãƒ¼ã‚¿ã¯ã€<br>
  <a href="https://wikiwiki.jp/dq10dic2nd/%E3%80%90%E3%83%A2%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%BC%E3%82%BF%E3%83%AD%E3%83%83%E3%83%88%E3%80%91#u55917ff" target="_blank" rel="noopener noreferrer">ã€DQ10å¤§è¾å…¸ã‚’ä½œã‚ã†ãœï¼ï¼ç¬¬äºŒç‰ˆ Wikiã€æ§˜ã®ãƒ‡ãƒ¼ã‚¿</a> ã‚’å¼•ç”¨ãƒ»å‚è€ƒã«ã•ã›ã¦ã„ãŸã ã„ã¦ãŠã‚Šã¾ã™ã€‚
</footer>

<script>
const ATK_ARCANAS = ['ç½ªäºº','æ­»ç¥','æ­£ç¾©','æˆ¦è»Š','å¡”'];
const H_ARCANAS = ['æ‚ªé­”','æ‹äºº','é‹å‘½','å¥³æ•™çš‡','å¯©åˆ¤','å¥³å¸','æœˆ','æ˜Ÿ'];

const ARCANA_DATA = [
  {name:'éš è€…',limit:4, color:'#ffebee', desc:'æ”»é­”ä¾å­˜ã®é—‡å±æ€§å˜ä½“æ”»æ’ƒ<br>é›·è€æ€§ä½ä¸‹ä»˜ä¸'}, 
  {name:'ç½ªäºº',limit:4, color:'#ffebee', desc:'æ”»é­”ä¾å­˜ã®é—‡å±æ€§å˜ä½“æ”»æ’ƒ<br>æ•µã«æ‚ªã„åŠ¹æœãŒã‚ã‚‹ã»ã©å¨åŠ›ä¸Šæ˜‡'}, 
  {name:'æ­»ç¥',limit:4, color:'#ffebee', desc:'æ”»é­”ä¾å­˜ã®é—‡å±æ€§ç¯„å›²æ”»æ’ƒ<br>HPæ¸›å°‘ã®å‘ªã„'}, 
  {name:'æ­£ç¾©',limit:4, color:'#ffebee', desc:'æ”»é­”ä¾å­˜ã®å…‰å±æ€§å˜ä½“æ”»æ’ƒ<br>æ•µãŒæ€’ã£ã¦ã„ã‚‹ã¨å¨åŠ›ä¸Šæ˜‡'}, 
  {name:'æˆ¦è»Š',limit:4, color:'#ffebee', desc:'æ”»æ’ƒåŠ›ä¾å­˜ã®ç„¡å±æ€§å˜ä½“æ”»æ’ƒã€‚<br>è‡ªåˆ†ã«è‰¯ã„åŠ¹æœãŒã‚ã‚‹ã¨å¨åŠ›ä¸Šæ˜‡'}, 
  {name:'å¡”',limit:4, color:'#ffebee', desc:'æ”»é­”ä¾å­˜ã®é›·å±æ€§ç¯„å›²æ”»æ’ƒ<br>é—‡è€æ€§ä½ä¸‹ä»˜ä¸'},
  {name:'æ‚ªé­”',limit:4, color:'#e3f2fd', desc:'æ•µå˜ä½“ã«ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯'}, 
  {name:'æ‹äºº',limit:4, color:'#e3f2fd', desc:'å‘³æ–¹1äººã«ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯(è‡ªåˆ†ä¸å¯)'}, 
  {name:'çš‡å¸',limit:2, color:'#e3f2fd', desc:'å‘³æ–¹1äººã«ãƒãƒ£ãƒ¼ã‚¸æ™‚é–“çŸ­ç¸®(10ç§’/ã‚ªãƒ¼ãƒ©15ç§’)'}, 
  {name:'ä¸–ç•Œ',limit:4, color:'#e3f2fd', desc:'è‡ªåˆ†ã¨å‘¨å›²ã®å‘³æ–¹ã«ã‚¹ãƒšãƒ«ã‚¬ãƒ¼ãƒ‰'}, 
  {name:'åŠ›',limit:4, color:'#e3f2fd', desc:'è‡ªåˆ†ã¨å‘¨å›²ã®å‘³æ–¹ãƒã‚¤ã‚­ãƒ«ãƒˆ'},   
  {name:'é­”è¡“å¸«',limit:5, color:'#e3f2fd', desc:'å‘³æ–¹1äººã«ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã‚’2æ®µéšä¸Šæ˜‡(è‡ªåˆ†ä¸å¯)'},
  {name:'é‹å‘½',limit:4, color:'#e8f5e9', desc:'é•·å°„ç¨‹å˜ä½“è˜‡ç”Ÿ åŸºç¤10m'}, 
  {name:'å¥³æ•™çš‡',limit:4, color:'#e8f5e9', desc:'ä»²é–“1äººã®HPã‚’å›å¾©ã—ã€æ‚ªã„åŠ¹æœã‚’æ¶ˆã™'}, 
  {name:'æ•™çš‡',limit:4, color:'#e8f5e9', desc:'è‡ªåˆ†ã¨å‘¨å›²ã®å‘³æ–¹ã«ã‚¹ã‚¯ãƒ«ãƒˆï¼‹ãƒªã‚¸ã‚§ãƒ'}, 
  {name:'å¯©åˆ¤',limit:2, color:'#e8f5e9', desc:'è‡ªåˆ†ã®å‘¨å›²ç¯„å›²è˜‡ç”Ÿ åŸºç¤8m'}, 
  {name:'ç¯€åˆ¶',limit:2, color:'#e8f5e9', desc:'è‡ªåˆ†ã¨å‘¨å›²ã®å‘³æ–¹ã«3ç§’ã«MP(5/ã‚ªãƒ¼ãƒ©10)ãšã¤å›å¾©ã®åŠ¹æœ'}, 
  {name:'å¤ªé™½',limit:2, color:'#e8f5e9', desc:'ãƒ™ãƒ›ãƒãƒ©ãƒ¼'},
  {name:'æ„šè€…',limit:2, color:'#f3e5f5', desc:'è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸1.2å€ã®é™£'}, 
  {name:'å¥³å¸',limit:4, color:'#f3e5f5', desc:'å¯¾è±¡ã¨ãã®å‘¨å›²ã®æ•µã«é­…äº†'}, 
  {name:'æœˆ',limit:4, color:'#f3e5f5', desc:'å¹»æƒ‘åŠ¹æœã®é™£'},   
  {name:'æ˜Ÿ',limit:4, color:'#f3e5f5', desc:'çœ ã‚ŠåŠ¹æœã®é™£'}
];

const MONSTER_DATA = [
  {name:'ã‚¢ãƒˆãƒ©ã‚¹',rank:'SSS',limit:1,ex:true, desc:'ä½¿ç”¨æ™‚ã®ä¼šå¿ƒç‡30%'}, {name:'ãƒã‚ºã‚º',rank:'SSS',limit:1,ex:true, desc:'ä½¿ç”¨æ™‚50%ã§ãƒ†ãƒ³ã‚·ãƒ§ãƒ³æ¶ˆè²»ã—ãªã„'},
  {name:'ãƒ™ãƒªã‚¢ãƒ«',rank:'SSS',limit:1,ex:true, desc:'ã‚ªãƒ¼ãƒ©ãŒå®¿ã‚‹ã¨ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ä¸Šæ˜‡'}, {name:'ãƒãƒ©ãƒ¢ã‚¹ã‚¾ãƒ³ãƒ“',rank:'SSS',limit:1,ex:true, desc:'ä½¿ç”¨æ™‚30%ã§æ‰‹æœ­ã«æ®‹ã‚‹'},
  {name:'ãƒãƒ©ãƒ¢ã‚¹ãƒ–ãƒ­ã‚¹',rank:'SSS',limit:1,ex:true, desc:'ä½¿ç”¨æ™‚30%ã§æ‰‹æœ­ã«æ®‹ã‚‹'}, {name:'ã‚­ãƒ³ã‚°ãƒ’ãƒ‰ãƒ©',rank:'SSS',limit:1,ex:true, desc:'ã‚ªãƒ¼ãƒ©ãŒå®¿ã‚‹ã¨ä½¿ç”¨æ™‚ã®æ”»æ’ƒãƒ€ãƒ¡ãƒ¼ã‚¸ãƒ»å›å¾©é‡ï¼‹200%'},
  {name:'ã‚¢ã‚¯ãƒãƒ¼',rank:'SSS',limit:1,ex:true, desc:'æ‰‹æœ­ã«å…¥ã£ãŸæ™‚è‡ªåˆ†ã®HP30%å›å¾©'}, {name:'ãƒ‡ãƒ¥ãƒ©ãƒ³',rank:'SSS',limit:1,ex:true, desc:'è‡ªåˆ†ã®HPãŒå…¨å¿«ãªã‚‰ä½¿ç”¨æ™‚åŠ¹æœ2å›ç™ºå‹•'},
  {name:'ã‚¸ãƒ£ãƒŸãƒ©ã‚¹',rank:'SSS',limit:1,ex:true, desc:'è‡ªåˆ†ã®HPãŒå…¨å¿«ãªã‚‰ä½¿ç”¨æ™‚ã®å›å¾©2å€'}, {name:'ã‚°ãƒ©ã‚³ã‚¹',rank:'SSS',limit:1,ex:true, desc:'æ‰‹æœ­ã«å…¥ã£ãŸæ™‚è‡ªåˆ†ã®HP&MP10%å›å¾©'},
  {name:'ã‚ãŸã¼ã†',rank:'SS',limit:1,ex:true, desc:'æˆ¦é—˜é–‹å§‹æ™‚ã«å¿…ãšæ‰‹æœ­ã«å…¥ã‚‹'}, {name:'ãƒ¯ãƒ«ã¼ã†',rank:'SS',limit:1,ex:true, desc:'æ‰‹æœ­ã«å…¥ã£ãŸæ™‚ã€ä»–ã®ã‚¿ãƒ­ãƒƒãƒˆã®ã‚ªãƒ¼ãƒ©æ¡ä»¶ã®ä»£ã‚ã‚Šã«ãªã‚‹'},
  {name:'ã‚¨ãƒ³ã‚¼ãƒ«ã‚¹ãƒ©ã‚¤ãƒ ',rank:'SS',limit:2,ex:true, desc:'ã€Œã‚¨ãƒ³ã‚¼ãƒ«ã®ã¿ã¡ã³ãã€ä½¿ç”¨æ™‚ã«æ‰‹æœ­ã«å‘¼ã¹ã‚‹'}, {name:'ãƒ¡ã‚«ãƒãƒ¼ãƒ³',rank:'SS',limit:2,ex:false, desc:'å—ã‘ã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸5æ¸›å°‘'},
  {name:'ãƒã‚¯ãƒ­ãƒãƒ«ã‚µ',rank:'SS',limit:2,ex:true, desc:'æ‰‹æœ­ã«å…¥ã£ãŸæ™‚20%ã§ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ä¸Šæ˜‡'}, {name:'ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¹ãƒ©ã‚¤ãƒ ',rank:'SS',limit:2,ex:false, desc:'æœ€å¤§HP+15'},
  {name:'ãƒ—ãƒ©ãƒãƒŠã‚­ãƒ³ã‚°',rank:'SS',limit:2,ex:false, desc:'æœ€å¤§HPï¼‹8'}, {name:'Sã‚­ãƒ©ãƒ¼ãƒã‚·ãƒ³',rank:'SS',limit:2,ex:false, desc:'ã¡ã‹ã‚‰+12'},
  {name:'ã‚­ãƒ©ãƒ¼ãƒã‚¸ãƒ³ã‚¬',rank:'SS',limit:2,ex:false, desc:'ã¡ã‹ã‚‰ï¼‹8'}, {name:'ãƒ©ãƒ³ãƒ—ã®ã¾ãŠã†',rank:'SS',limit:2,ex:false, desc:'ã“ã†ã’ãé­”åŠ›+30'},
  {name:'ãƒ˜ãƒ«ãƒãƒˆãƒ©ãƒ¼',rank:'SS',limit:2,ex:false, desc:'ã“ã†ã’ãé­”åŠ›ï¼‹24'}, {name:'ãƒ¡ã‚¤ãƒ‡ãƒ³ãƒ‰ãƒ¼ãƒ«',rank:'SS',limit:2,ex:false, desc:'ã‹ã„ãµãé­”åŠ›+30'},
  {name:'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ãƒ›ãƒ¼ã‚¹',rank:'SS',limit:2,ex:false, desc:'ã‹ã„ãµãé­”åŠ›ï¼‹25'},
  {name:'ãã‚‰ã‚„ã¿ãƒãƒ¼ãƒ”ãƒ¼',rank:'S',limit:2,ex:false, desc:'è¨­ç½®å‹ä»¥å¤–ã®ã‚¿ãƒ­ãƒƒãƒˆã®åŠ¹æœç¯„å›²+0.5mã€ã‚¿ãƒ­ãƒƒãƒˆã®å°„ç¨‹è·é›¢ï¼‹0.5m'}, {name:'ãƒŸã‚±ã¾ã©ã†',rank:'S',limit:2,ex:false, desc:'ã‚¿ãƒ­ãƒƒãƒˆã®å°„ç¨‹è·é›¢ï¼‹2m'},
  {name:'ãƒãƒƒãƒ‰ã‚¹ãƒŸã‚¹',rank:'S',limit:2,ex:false, desc:'è¨­ç½®å‹ä»¥å¤–ã®ã‚¿ãƒ­ãƒƒãƒˆã®åŠ¹æœç¯„å›²ï¼‹1m'}, {name:'ãƒ¡ã‚¿ãƒ«ã‚¹ãƒ©ã‚¤ãƒ ',rank:'S',limit:5,ex:false, desc:'èº«ã‹ã‚ã—ç‡ï¼‹0.3%'},
  {name:'ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚³ãƒ¼ãƒ³',rank:'S',limit:5,ex:false, desc:'ã™ã°ã‚„ã•ï¼‹8'}, {name:'ã¤ã‚€ã‚Šã‚“ãƒãƒ',rank:'S',limit:5,ex:false, desc:'ã¿ã®ã¾ã‚‚ã‚Šï¼‹4'},
  {name:'ãƒ¡ã‚¿ãƒ«ãƒ›ã‚¤ãƒŸãƒ³',rank:'S',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚è‡ªåˆ†ã®HP25å›å¾©'}, {name:'ãƒ„ãƒ³ãƒ‰ãƒ©ã‚­ãƒ¼',rank:'S',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚è‡ªåˆ†ã®MP12å›å¾©'},
  {name:'ã¡ã‚‡ã†ã‚ã†ã˜ã‚…',rank:'S',limit:5,ex:false, desc:'ã‹ã„ãµãé­”åŠ›ï¼‹8'}, {name:'ãƒ™ãƒ“ãƒ³ã‚´ã‚µã‚¿ãƒ³',rank:'S',limit:5,ex:false, desc:'ã“ã†ã’ãé­”åŠ›ï¼‹8'},
  {name:'ãƒ ãƒ¼ãƒ³ã‚­ãƒ¡ãƒ©',rank:'S',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚è‡ªåˆ†ã®HP12%å›å¾©'}, {name:'ã‚­ãƒ©ãƒ¼ãƒ”ãƒƒã‚±ãƒ«',rank:'S',limit:5,ex:true, desc:'æ‰‹æœ­ã«å…¥ã£ãŸæ™‚10%ã§ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ä¸Šæ˜‡'},
  {name:'ã‚¹ã‚¤ãƒ¼ãƒ„ãƒˆãƒ­ãƒ«',rank:'S',limit:5,ex:true, desc:'æ‰‹æœ­ã«å…¥ã£ãŸæ™‚15%ã§ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ä¸Šæ˜‡'}, {name:'ãƒ¢ãƒƒãƒ„ã‚¡ãƒ¬ãƒ¼ãƒ©',rank:'S',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚è‡ªåˆ†ã®MP50å›å¾©'},
  {name:'ãƒ”ãƒ³ã‚¯ãƒœãƒ³ãƒœãƒ³',rank:'S',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚å‘³æ–¹å…¨å“¡ã®HP12%å›å¾©'}, {name:'ã‚¹ã‚¦ã‚£ãƒ¼ãƒˆãƒãƒƒã‚°',rank:'S',limit:5,ex:true, desc:'ä½¿ç”¨æ™‚30%ã§æ‰‹æœ­ã«æ®‹ã‚‹'},
  {name:'æ­»ã®ã‚«ãƒ©ã‚¹ãƒ†ãƒ³ã‚°',rank:'S',limit:5,ex:false, desc:'æœ€å¤§MPï¼‹15'}, {name:'ã‚¿ã‚¤ãƒ—G',rank:'S',limit:5,ex:false, desc:'ã¡ã‹ã‚‰ï¼‹4'},
  {name:'ãƒ¡ã‚¿ãƒ«ã‚­ãƒ³ã‚°',rank:'S',limit:5,ex:false, desc:'æœ€å¤§HPï¼‹3'}, {name:'ã‚¢ã‚¹ã‚¿ãƒ­ãƒˆ',rank:'S',limit:5,ex:true, desc:'ä½¿ç”¨æ™‚20%ã§ãƒ†ãƒ³ã‚·ãƒ§ãƒ³æ¶ˆè²»ã—ãªã„'},
  {name:'ã‚­ãƒ³ã‚°ã‚¨ãƒ¬ãƒ•ã‚¡ãƒ³ãƒˆ',rank:'S',limit:5,ex:true, desc:'ä½¿ç”¨æ™‚30%ã§åŠ¹æœ2å›ç™ºå‹•'},
  {name:'ãƒªãƒ“ãƒ³ã‚°ãƒ‡ãƒƒãƒ‰',rank:'A',limit:2,ex:false, desc:'è¨­ç½®å‹ä»¥å¤–ã®ã‚¿ãƒ­ãƒƒãƒˆã®åŠ¹æœç¯„å›²ï¼‹0.3m'}, {name:'ã‚¹ãƒ©ã‚¤ãƒ ã‚¿ãƒ¯ãƒ¼',rank:'A',limit:5,ex:false, desc:'èº«ã‹ã‚ã—ç‡ï¼‹0.2%'},
  {name:'ãƒ–ãƒ©ãƒãƒ‹ã‚¯ã‚¤ãƒ¼ãƒ³',rank:'A',limit:5,ex:false, desc:'ã™ã°ã‚„ã•ï¼‹7'}, {name:'ã¤ã‚‰ã‚‰ã‚¹ãƒ©ã‚¤ãƒ ',rank:'A',limit:5,ex:false, desc:'ã¿ã®ã¾ã‚‚ã‚Šï¼‹3'},
  {name:'ãƒ™ãƒ›ãƒã‚¹ãƒ©ã‚¤ãƒ ',rank:'A',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚è‡ªåˆ†ã®HP20å›å¾©'}, {name:'ãƒ‰ãƒ©ã‚­ãƒ¼ãƒ',rank:'A',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚è‡ªåˆ†ã®MP10å›å¾©'},
  {name:'ã‚¨ãƒ“ãƒ«ãƒˆãƒ¬ãƒ³ãƒˆ',rank:'A',limit:5,ex:false, desc:'ã‹ã„ãµãé­”åŠ›ï¼‹5'}, {name:'ãƒŸãƒ‹ãƒ‡ãƒ¼ãƒ¢ãƒ³',rank:'A',limit:5,ex:false, desc:'ã“ã†ã’ãé­”åŠ›ï¼‹5'},
  {name:'ãƒ€ãƒ¼ã‚¯ãƒšãƒ«ã‚·ãƒ£',rank:'A',limit:5,ex:false, desc:'ã‚¿ãƒ­ãƒƒãƒˆã®å°„ç¨‹è·é›¢ï¼‹0.5m'}, {name:'ã‚¹ã‚¿ãƒ¼ã‚­ãƒ¡ãƒ©',rank:'A',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚è‡ªåˆ†ã®HP5%å›å¾©'},
  {name:'ãƒ–ãƒ©ãƒ³ãƒãƒˆãƒƒã‚¯',rank:'A',limit:5,ex:false, desc:'æ‰‹æœ­ã«å…¥ã£ãŸæ™‚5%ã§ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ä¸Šæ˜‡'}, {name:'ãƒˆãƒ­ãƒ«ã‚­ãƒ³ã‚°',rank:'A',limit:5,ex:false, desc:'æ‰‹æœ­ã«å…¥ã£ãŸæ™‚10%ã§ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ä¸Šæ˜‡'},
  {name:'ãã‚ã‚«ãƒ“ã“ãã†',rank:'A',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚è‡ªåˆ†ã®MP30å›å¾©'}, {name:'ãƒ•ã‚¡ãƒ¼ãƒ©ãƒƒãƒˆ',rank:'A',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚orå¼•ãç›´ã—æ™‚å‘³æ–¹å…¨å“¡ã®HP5%å›å¾©'},
  {name:'ãŠã©ã‚‹ã»ã†ã›ã',rank:'A',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚10%ã§æ‰‹æœ­ã«æ®‹ã‚‹'}, {name:'ã‚¬ãƒ¼ã‚´ã‚¤ãƒ«',rank:'A',limit:5,ex:false, desc:'æœ€å¤§MPï¼‹5'},
  {name:'ã‚­ãƒ©ãƒ¼ãƒã‚·ãƒ³',rank:'A',limit:5,ex:false, desc:'ã¡ã‹ã‚‰ï¼‹3'}, {name:'ã‚¯ã‚¤ãƒ¼ãƒ³ã‚¹ãƒ©ã‚¤ãƒ ',rank:'A',limit:5,ex:false, desc:'æœ€å¤§HPï¼‹2'},
  {name:'ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ãƒ¼ãƒ³',rank:'A',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚10%ã§ãƒ†ãƒ³ã‚·ãƒ§ãƒ³æ¶ˆè²»ã—ãªã„'}, {name:'ã‚¬ãƒãƒ¼ã‚·ãƒ£ã‚¨ãƒ“ãƒ«',rank:'A',limit:5,ex:false, desc:'ä½¿ç”¨æ™‚10%ã§åŠ¹æœ2å›ç™ºå‹•'},
  {name:'ãã•ã£ãŸæ­»ä½“',rank:'B',limit:2,ex:false, desc:'è¨­ç½®å‹ä»¥å¤–ã®ã‚¿ãƒ­ãƒƒãƒˆã®åŠ¹æœç¯„å›²ï¼‹0.1m'}
];

const RARITY_WEIGHT = {
  'ãã‚‰ã‚„ã¿ãƒãƒ¼ãƒ”ãƒ¼': 100000, 'ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¹ãƒ©ã‚¤ãƒ ': 100000, 'Sã‚­ãƒ©ãƒ¼ãƒã‚·ãƒ³': 100000,
  'ãƒ¡ã‚«ãƒãƒ¼ãƒ³': 50000, 'ãƒ—ãƒ©ãƒãƒŠã‚­ãƒ³ã‚°': 50000
};
function getWeight(mName) {
  if(RARITY_WEIGHT[mName]) return RARITY_WEIGHT[mName];
  const rank = MONSTER_DATA.find(m=>m.name===mName).rank;
  if(rank === 'SSS') return 1000;
  if(rank === 'SS') return 500;
  if(rank === 'S') return 100;
  if(rank === 'A') return 10;
  return 1;
}

// ================= STATE =================
let appState = { arcanaCounts: {}, arcanaPriorities: {}, monsterCounts: {}, exceptionData: {}, optimizedResult: {} };
let savedDecks = [];
let backupDecks = null; // Undoç”¨
let activeTabId = 'arcana';

window.onload = () => {
  const s = localStorage.getItem('dq10_v54_state'); if(s) appState = JSON.parse(s); else resetStateBase();
  const d = localStorage.getItem('dq10_v54_decks'); if(d) savedDecks = JSON.parse(d);
  renderAll();
};

function resetStateBase() {
  ARCANA_DATA.forEach(a => {
    appState.arcanaCounts[a.name] = 0;
    let p = 'N'; if(ATK_ARCANAS.includes(a.name)) p = 'A'; else if(a.name === 'æ•™çš‡') p = 'D'; else if(H_ARCANAS.includes(a.name)) p = 'H';
    appState.arcanaPriorities[a.name] = p;
  });
  appState.monsterCounts = {}; appState.exceptionData = {}; appState.optimizedResult = {};
}

function resetTab(tabId) {
  if(!confirm('ç¾åœ¨ã®ã‚¿ãƒ–ã®å†…å®¹ã®ã¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  if(tabId === 'arcana') {
    const resetOpt = document.getElementById('chk-reset-opt').checked;
    ARCANA_DATA.forEach(a => {
      appState.arcanaCounts[a.name] = 0;
      if(resetOpt) {
        let p = 'N'; if(ATK_ARCANAS.includes(a.name)) p = 'A'; else if(a.name === 'æ•™çš‡') p = 'D'; else if(H_ARCANAS.includes(a.name)) p = 'H';
        appState.arcanaPriorities[a.name] = p;
      }
    });
  } else if(tabId === 'monster') {
    appState.monsterCounts = {}; appState.exceptionData = {};
  } else if(tabId === 'exception') {
    appState.exceptionData = {};
  }
  saveData(); renderAll();
}

function saveData() { localStorage.setItem('dq10_v54_state', JSON.stringify(appState)); updateStats(); }

function updateStats() {
  let aCount = Object.values(appState.arcanaCounts).reduce((a,b)=>a+b,0);
  let mCount = Object.values(appState.monsterCounts).reduce((a,b)=>a+b,0);
  
  let arcEl = document.getElementById('stat-arc');
  let monEl = document.getElementById('stat-mon');
  let arcCont = document.getElementById('stat-arc-container');
  let monCont = document.getElementById('stat-mon-container');
  
  arcEl.textContent = aCount; monEl.textContent = mCount;
  
  if(aCount === 20) arcCont.classList.add('ok'); else arcCont.classList.remove('ok');
  if(mCount === 20) monCont.classList.add('ok'); else monCont.classList.remove('ok');

  const warn = document.getElementById('warning-msg');
  const btn = document.getElementById('btn-run');
  if(aCount !== 20 || mCount !== 20) { 
    btn.disabled = true; 
    if(activeTabId === 'result') warn.style.display = 'block'; else warn.style.display = 'none';
  } else { 
    btn.disabled = false; 
    warn.style.display = 'none'; 
  }
}

function toggleDesc(id) {
  const el = document.getElementById(id);
  if(el) el.style.display = (el.style.display === 'none') ? 'table-row' : 'none';
}

// ================= RENDER =================
function renderAll() { renderArcana(); renderMonster(); renderException(); renderDeckList(); }

function renderArcana() {
  const tbody = document.getElementById('tbody-arcana'); tbody.innerHTML = '';
  ARCANA_DATA.forEach(a => {
    const cnt = appState.arcanaCounts[a.name] || 0; const prio = appState.arcanaPriorities[a.name];
    const tr = document.createElement('tr'); tr.style.backgroundColor = a.color; tr.className = 'click-row';
    tr.onclick = () => toggleDesc('arc-desc-' + a.name);
    tr.innerHTML = `<td><b>${a.name}</b></td>
      <td><div style="display:flex; align-items:center;">
      <button class="btn-count btn-minus" onclick="event.stopPropagation(); modArc('${a.name}', -1, ${a.limit})">ï¼</button>
      <span class="val-display">${cnt}</span>
      <button class="btn-count btn-plus" onclick="event.stopPropagation(); modArc('${a.name}', 1, ${a.limit})">ï¼‹</button></div></td>
      <td><div class="prio-group">${['H','A','N','D'].map(x => `<button class="prio-btn ${prio===x?'active-'+x:''}" onclick="event.stopPropagation(); setPrio('${a.name}', '${x}')">${x}</button>`).join('')}</div></td>`;
    tbody.appendChild(tr);
    
    const trDesc = document.createElement('tr'); trDesc.id = 'arc-desc-' + a.name; trDesc.className = 'desc-row'; trDesc.style.display = 'none';
    trDesc.innerHTML = `<td colspan="3">${a.desc}</td>`;
    tbody.appendChild(trDesc);
  });
  updateStats();
}
function modArc(name, d, limit) { let v = (appState.arcanaCounts[name] || 0) + d; if(v < 0) v = 0; if(v > limit) v = limit; appState.arcanaCounts[name] = v; saveData(); renderArcana(); }
function setPrio(name, p) { appState.arcanaPriorities[name] = p; saveData(); renderArcana(); }

function renderMonster() {
  const tbody = document.getElementById('tbody-monster'); tbody.innerHTML = ''; let lastRank = '';
  MONSTER_DATA.forEach(m => {
    if(m.rank !== lastRank) { const trH = document.createElement('tr'); trH.innerHTML = `<td colspan="2" style="background:#eee; font-weight:bold; font-size:11px; padding:6px;">â–¼ ${m.rank}ãƒ©ãƒ³ã‚¯</td>`; tbody.appendChild(trH); lastRank = m.rank; }
    
    if(m.name === 'ãƒãƒ©ãƒ¢ã‚¹ã‚¾ãƒ³ãƒ“' || m.name === 'ã‚¢ã‚¯ãƒãƒ¼') {
      const trLine = document.createElement('tr'); 
      trLine.innerHTML = `<td colspan="2" style="border-top: 2px dashed #9fa8da; padding: 0; height: 0;"></td>`; 
      tbody.appendChild(trLine);
    }

    const cnt = appState.monsterCounts[m.name] || 0; const tr = document.createElement('tr'); 
    if(cnt > 0) tr.style.backgroundColor = '#e8f5e9'; else tr.style.backgroundColor = '#fff';
    tr.className = 'click-row';
    tr.onclick = () => toggleDesc('mon-desc-' + m.name);
    
    tr.innerHTML = `<td><span class="rank-badge rk-${m.rank}">${m.rank}</span> <b>${m.name}</b></td>
      <td style="text-align:right;"><div style="display:flex; align-items:center; justify-content:flex-end;">
      <button class="btn-count btn-minus" onclick="event.stopPropagation(); modMon('${m.name}', -1, ${m.limit})">ï¼</button>
      <span class="val-display">${cnt}</span><button class="btn-count btn-plus" onclick="event.stopPropagation(); modMon('${m.name}', 1, ${m.limit})">ï¼‹</button></div></td>`;
    tbody.appendChild(tr);
    
    const trDesc = document.createElement('tr'); trDesc.id = 'mon-desc-' + m.name; trDesc.className = 'desc-row'; trDesc.style.display = 'none';
    trDesc.innerHTML = `<td colspan="2">${m.desc}</td>`;
    tbody.appendChild(trDesc);
  });
  updateStats();
}
function modMon(name, d, limit) { let v = (appState.monsterCounts[name] || 0) + d; if(v < 0) v = 0; if(v > limit) v = limit; appState.monsterCounts[name] = v; saveData(); renderMonster(); renderException(); }

function renderException() {
  const c = document.getElementById('exception-content'); c.innerHTML = '';
  const am = MONSTER_DATA.filter(m => (appState.monsterCounts[m.name] || 0) > 0);
  if(am.length === 0) { c.innerHTML = '<div style="padding:15px; text-align:center; color:#888; background:#fff; border-radius:6px; border:1px solid #eee;">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</div>'; return; }
  am.sort((a,b) => (b.ex ? 1 : 0) - (a.ex ? 1 : 0));
  
  let html = '<table><thead><tr><th style="width:140px;">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼</th><th>å›ºå®šã‚¢ãƒ«ã‚«ãƒŠ</th></tr></thead><tbody>';
  am.forEach(m => {
    const cnt = appState.monsterCounts[m.name]; let selHTML = '';
    for(let i=0; i<cnt; i++) {
      const savedVal = (appState.exceptionData[m.name] || [])[i] || ''; const color = getArcanaColor(savedVal);
      let opts = `<option value="">(è‡ªå‹•)</option>`;
      ARCANA_DATA.filter(a => appState.arcanaCounts[a.name] > 0).forEach(a => { opts += `<option value="${a.name}" ${savedVal===a.name?'selected':''} style="background:${a.color}">${a.name}</option>`; });
      selHTML += `<select onchange="updateEx('${m.name}', ${i}, this)" style="margin-bottom:4px; display:block; background:${color}; width:100%; border:1px solid #ccc; padding:6px; font-weight:bold;">${opts}</select>`;
    }
    let bg = m.ex ? '#fff9c4' : '#fff';
    html += `<tr style="background:${bg};"><td><b>${m.name}</b>${m.ex?'<br><span class="ex-tag">æ¨å¥¨</span>':''}</td><td>${selHTML}</td></tr>`;
  });
  html += '</tbody></table>';
  c.innerHTML = html;
}
function updateEx(mName, idx, el) { if(!appState.exceptionData[mName]) appState.exceptionData[mName] = []; appState.exceptionData[mName][idx] = el.value; el.style.backgroundColor = getArcanaColor(el.value); saveData(); }
function getArcanaColor(name) { const f = ARCANA_DATA.find(a=>a.name===name); return f ? f.color : '#fff'; }

// ================= LOGIC CORE =================
function getPairScore(t1, t2, isLimit5) {
  if(isLimit5) {
    let score = 0;
    if(t1 === 'D') score -= 50;
    if(t2 === 'D') score -= 50;
    return score;
  }
  
  if (!t1 || !t2) return 0; const p = [t1, t2].sort().join('');
  if (p === 'AH' || p === 'DN') return 0;
  if (p === 'AD' || p === 'AN' || p === 'HN' || p === 'NN') return 100;
  if (p === 'AA' || p === 'HH') return 10000;
  if (p === 'DH') return 100000;
  return 1000;
}

function getPermutations(arr) {
  if (arr.length <= 1) return [arr]; let perms = [];
  for (let i = 0; i < arr.length; i++) {
    let rest = arr.slice(0, i).concat(arr.slice(i + 1));
    let restPerms = getPermutations(rest);
    for (let p of restPerms) perms.push([arr[i]].concat(p));
  }
  return perms;
}

function buildDeckData(state) {
  let pool = { A:0, N:0, D:0, H:0 }; let poolNames = { A:[], N:[], D:[], H:[] };
  for(let aName in state.arcanaCounts) {
    let type = state.arcanaPriorities[aName] || 'N'; pool[type] += state.arcanaCounts[aName];
    for(let i=0; i<state.arcanaCounts[aName]; i++) poolNames[type].push(aName);
  }
  let pairs = []; let unassignedSlots = [];
  MONSTER_DATA.forEach(m => {
    let count = state.monsterCounts[m.name] || 0; if(count === 0) return;
    let isB = (m.rank === 'B'); let isLimit5 = (m.limit === 5); let fixed = state.exceptionData[m.name] || [];
    for(let i=0; i<count; i+=2) {
      let slot1 = { mName: m.name, isB: isB, isLimit5: isLimit5, type: null, fixedName: null, idx: i };
      let slot2 = (i + 1 < count) ? { mName: m.name, isB: isB, isLimit5: isLimit5, type: null, fixedName: null, idx: i+1 } : null;
      if(fixed[i] && poolNames[state.arcanaPriorities[fixed[i]]].includes(fixed[i])) {
        slot1.fixedName = fixed[i]; slot1.type = state.arcanaPriorities[fixed[i]];
        pool[slot1.type]--; poolNames[slot1.type].splice(poolNames[slot1.type].indexOf(fixed[i]), 1);
      }
      if(slot2 && fixed[i+1] && poolNames[state.arcanaPriorities[fixed[i+1]]].includes(fixed[i+1])) {
        slot2.fixedName = fixed[i+1]; slot2.type = state.arcanaPriorities[fixed[i+1]];
        pool[slot2.type]--; poolNames[slot2.type].splice(poolNames[slot2.type].indexOf(fixed[i+1]), 1);
      }
      pairs.push([slot1, slot2]);
      if(!slot1.fixedName) unassignedSlots.push(slot1);
      if(slot2 && !slot2.fixedName) unassignedSlots.push(slot2);
    }
  });
  return { state, pool, poolNames, pairs, unassignedSlots };
}

function dfsBestScore(pairs, pool) {
  let memo = {}; // å‘¼ã³å‡ºã—ã”ã¨ã«æ¯å›ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆæ±šæŸ“é˜²æ­¢ï¼‰
  
  function solve(pairIdx, curA, curN, curD, curH) {
    if (pairIdx === pairs.length) return { score: 0, assignment: [] };
    let key = `${pairIdx}_${curA}_${curN}_${curD}_${curH}`;
    if (memo[key] !== undefined) return memo[key];

    let p1 = pairs[pairIdx][0], p2 = pairs[pairIdx][1];
    let isB = p1.isB; let isLim5 = p1.isLimit5;
    let curPool = { A: curA, N: curN, D: curD, H: curH };
    let cands = [];

    const canUse = (t) => { return !(isB && t === 'A'); };
    const canPair = (t1, t2) => {
      if(isLim5) return true; 
      if(t1 === 'D' && t2 === 'H') return false;
      if(t1 === 'H' && t2 === 'D') return false;
      return true;
    };

    if (p2 === null) {
      if (p1.type !== null) cands.push([p1.type, null]);
      else ['A','N','D','H'].forEach(t => { if (curPool[t] > 0 && canUse(t)) cands.push([t, null]); });
    } else {
      if (p1.type !== null && p2.type !== null) cands.push([p1.type, p2.type]);
      else if (p1.type !== null && p2.type === null) {
        ['A','N','D','H'].forEach(t => { if (curPool[t] > 0 && canUse(t) && canPair(p1.type, t)) cands.push([p1.type, t]); });
      } else if (p1.type === null && p2.type !== null) {
        ['A','N','D','H'].forEach(t => { if (curPool[t] > 0 && canUse(t) && canPair(t, p2.type)) cands.push([t, p2.type]); });
      } else {
        let types = ['A','N','D','H'];
        for(let i=0; i<4; i++) {
          for(let j=i; j<4; j++) {
            let t1 = types[i], t2 = types[j];
            if (!canUse(t1) || !canUse(t2)) continue;
            if (!canPair(t1, t2)) continue;
            if (t1 === t2) { if (curPool[t1] >= 2) cands.push([t1, t2]); }
            else { if (curPool[t1] >= 1 && curPool[t2] >= 1) cands.push([t1, t2]); }
          }
        }
      }
    }

    let bestScore = Infinity; let bestAssign = null;
    for (let c of cands) {
      let cost1 = (p1.type === null) ? c[0] : null; let cost2 = (p2 !== null && p2.type === null) ? c[1] : null;
      if (cost1) curPool[cost1]--; if (cost2) curPool[cost2]--;
      
      let res = solve(pairIdx + 1, curPool.A, curPool.N, curPool.D, curPool.H);
      if (res.score !== Infinity) {
        let total = getPairScore(c[0], c[1], isLim5) + res.score;
        if (total < bestScore) { bestScore = total; bestAssign = [c].concat(res.assignment); }
      }
      
      if (cost1) curPool[cost1]++; if (cost2) curPool[cost2]++;
    }
    memo[key] = { score: bestScore, assignment: bestAssign };
    return memo[key];
  }
  return solve(0, pool.A, pool.N, pool.D, pool.H);
}

function optimizeSingleDeck(deck) {
  let dd = buildDeckData(deck.state);
  
  let bNeed = 0; dd.unassignedSlots.forEach(s => { if(s.isB) bNeed++; });
  if(bNeed > (dd.pool['N'] + dd.pool['D'] + dd.pool['H'])) return { error: true, msg: "Bãƒ©ãƒ³ã‚¯ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹Aä»¥å¤–ã®ã‚«ãƒ¼ãƒ‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚" };

  let res = dfsBestScore(dd.pairs, dd.pool);
  if(res.score === Infinity) return { error: true, msg: "ç¦æ­¢ãƒ«ãƒ¼ãƒ«ã‚’å›é¿ã§ãã‚‹çµ„ã¿åˆã‚ã›ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚" };

  let resMap = {};
  for(let i=0; i<dd.pairs.length; i++) {
    let p1 = dd.pairs[i][0], p2 = dd.pairs[i][1]; let t1 = res.assignment[i][0], t2 = res.assignment[i][1];
    if(!resMap[p1.mName]) resMap[p1.mName] = [];
    resMap[p1.mName][p1.idx] = p1.fixedName ? p1.fixedName : dd.poolNames[t1].pop();
    if(p2) {
      if(!resMap[p2.mName]) resMap[p2.mName] = [];
      resMap[p2.mName][p2.idx] = p2.fixedName ? p2.fixedName : dd.poolNames[t2].pop();
    }
  }
  return { error: false, map: resMap, score: res.score };
}

// ================= RUN UI =================
async function runSingleOptimizeUI() {
  const c = document.getElementById('result-content'); c.innerHTML = '<div class="loading">ãƒ‡ãƒƒã‚­ä½œæˆä¸­...</div>';
  await new Promise(r => setTimeout(r, 10));
  let res = optimizeSingleDeck({state: appState});
  if(res.error) { c.innerHTML = `<span style="color:red; font-weight:bold;">ã‚¨ãƒ©ãƒ¼: ${res.msg}</span>`; return; }
  appState.optimizedResult = {}; for(let m in res.map) appState.optimizedResult[m] = res.map[m].filter(x=>x); saveData();
  renderResult(appState.optimizedResult, c, appState);
}

function renderResult(map, container, state) {
  let html = '<table><thead><tr><th>ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼</th><th>æ§‹æˆ</th></tr></thead><tbody>';
  MONSTER_DATA.forEach(m => {
    if(map[m.name]) {
      let badges = map[m.name].map(name => `<span class="res-card res-${state.arcanaPriorities[name]||'N'}">${name}</span>`).join('');
      html += `<tr><td><b>${m.name}</b> <span class="rank-badge rk-${m.rank}">${m.rank}</span></td><td>${badges}</td></tr>`;
    }
  });
  container.innerHTML = html + '</tbody></table>';
}

function calculateNeedsOnly() {
  const output = document.getElementById('global-result');
  if(savedDecks.length === 0) { output.innerHTML = '<span style="color:red; font-weight:bold;">ä¿å­˜ãƒ‡ãƒƒã‚­ãŒã‚ã‚Šã¾ã›ã‚“</span>'; return; }
  
  let finalGlobalNeeds = {};
  savedDecks.forEach(d => {
    if(!d.state.optimizedResult || Object.keys(d.state.optimizedResult).length === 0) return; 
    for(let mName in d.state.optimizedResult) {
      if(!finalGlobalNeeds[mName]) finalGlobalNeeds[mName] = {}; let localCounts = {};
      d.state.optimizedResult[mName].forEach(c => localCounts[c] = (localCounts[c]||0)+1);
      for(let c in localCounts) finalGlobalNeeds[mName][c] = Math.max(finalGlobalNeeds[mName][c] || 0, localCounts[c]);
    }
  });
  if(Object.keys(finalGlobalNeeds).length === 0) {
    output.innerHTML = '<span style="color:red; font-weight:bold;">ã™ã¹ã¦ã®ãƒ‡ãƒƒã‚­ãŒæœªä½œæˆï¼ˆè¨ˆç®—å‰ï¼‰ã§ã™ã€‚</span>'; return;
  }
  renderCardList(finalGlobalNeeds, output, "ğŸ“Š ç¾åœ¨ã®å¿…è¦ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ");
}

function undoOptimization() {
  if(!backupDecks) { alert("æˆ»ã›ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
  savedDecks = JSON.parse(JSON.stringify(backupDecks));
  localStorage.setItem('dq10_v54_decks', JSON.stringify(savedDecks));
  renderDeckList();
  document.getElementById('global-result').innerHTML = '<span style="color:var(--success); font-weight:bold;">ä¸€å€‹å‰ã®çŠ¶æ…‹ã«å¾©å…ƒã—ã¾ã—ãŸã€‚</span>';
}

async function runGlobalOptimizationUI() {
  const output = document.getElementById('global-result');
  if(savedDecks.length === 0) { output.innerHTML = '<span style="color:red; font-weight:bold;">ä¿å­˜ãƒ‡ãƒƒã‚­ãŒã‚ã‚Šã¾ã›ã‚“</span>'; return; }
  
  backupDecks = JSON.parse(JSON.stringify(savedDecks));
  
  output.innerHTML = '<div class="loading">Step 1: å„ãƒ‡ãƒƒã‚­ã®çµ¶å¯¾é˜²è¡›ãƒ©ã‚¤ãƒ³(æœ€é«˜ã®ç¾ã—ã•)ã‚’ç®—å‡ºä¸­...</div>';
  await new Promise(r => setTimeout(r, 10));
  
  let initialBestScores = [];
  for(let i=0; i<savedDecks.length; i++) {
    let dd = buildDeckData(savedDecks[i].state); 
    let res = dfsBestScore(dd.pairs, dd.pool);
    if(res.score === Infinity) { output.innerHTML = `<span style="color:red; font-weight:bold;">ãƒ‡ãƒƒã‚­ã€Œ${savedDecks[i].name}ã€ã®ã‚¨ãƒ©ãƒ¼: ç¦æ­¢ãƒšã‚¢ã‚’å›é¿ã§ãã¾ã›ã‚“ã€‚æ‰‹å‹•ã§æ§‹æˆã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚</span>`; return; }
    initialBestScores.push(res.score);
  }
  
  output.innerHTML = '<div class="loading">Step 2: ç©¶æ¥µãƒ»å…¨ãƒ«ãƒ¼ãƒˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œä¸­...<br><small>ï¼ˆæœ€é©è§£ã‚’æ¤œç´¢ä¸­ã§ã™ã€‚æ•°ç§’ã‹ã‹ã‚Šã¾ã™ï¼‰</small></div>';
  await new Promise(r => setTimeout(r, 10));

  let mSet = new Set();
  savedDecks.forEach(d => { let dd = buildDeckData(d.state); dd.unassignedSlots.forEach(s => mSet.add(s.mName)); });
  let allUsedMonsters = Array.from(mSet);
  
  let rareMonsters = allUsedMonsters.filter(m => getWeight(m) >= 50000);
  let normalMonsters = allUsedMonsters.filter(m => getWeight(m) < 50000).sort((a,b) => getWeight(b) - getWeight(a));
  
  let rarePerms = getPermutations(rareMonsters);
  if(rarePerms.length === 0) rarePerms = [[]]; 
  
  let bestGlobalCost = Infinity;
  let bestResultMaps = null;

  for(let perm of rarePerms) {
    let simDecks = savedDecks.map((d, i) => {
      let dd = buildDeckData(d.state); dd.bestScore = initialBestScores[i]; return dd;
    });
    
    let processOrder = perm.concat(normalMonsters);
    
    for(let mName of processOrder) {
      let maxNeeded = Math.max(...simDecks.map(dd => dd.unassignedSlots.filter(s => s.mName === mName).length));
      if(maxNeeded === 0) continue;
      
      for(let slotIdx = 0; slotIdx < maxNeeded; slotIdx++) {
        let targetDecks = simDecks.filter(dd => dd.unassignedSlots.filter(s => s.mName === mName).length > slotIdx);
        if(targetDecks.length === 0) continue;
        
        let arcanaFreq = {};
        targetDecks.forEach(dd => {
          let uniqueArcs = new Set();
          for(let type in dd.poolNames) dd.poolNames[type].forEach(a => uniqueArcs.add(a));
          uniqueArcs.forEach(a => { arcanaFreq[a] = (arcanaFreq[a] || 0) + 1; });
        });
        let candidates = Object.keys(arcanaFreq).sort((a,b) => arcanaFreq[b] - arcanaFreq[a]);
        
        let bestCandidate = null; let maxAppliedDecks = -1;
        
        for(let cand of candidates) {
          let appliedDecks = []; let type = savedDecks[0].state.arcanaPriorities[cand];
          
          for(let i=0; i<targetDecks.length; i++) {
            let dd = targetDecks[i];
            
            if(!dd.poolNames[type].includes(cand)) continue; 
            let slot = dd.unassignedSlots.filter(s => s.mName === mName)[slotIdx];
            if(slot.isB && type === 'A') continue; 
            
            slot.fixedName = cand; slot.type = type; dd.pool[type]--;
            let testRes = dfsBestScore(dd.pairs, dd.pool);
            if(testRes.score <= dd.bestScore) appliedDecks.push(dd); 
            slot.fixedName = null; slot.type = null; dd.pool[type]++;
          }
          if(appliedDecks.length > maxAppliedDecks) { maxAppliedDecks = appliedDecks.length; bestCandidate = { name: cand, type: type, decks: appliedDecks }; }
          if(maxAppliedDecks === targetDecks.length) break; 
        }
        
        if(bestCandidate && bestCandidate.decks.length > 0) {
          bestCandidate.decks.forEach(dd => {
            let slot = dd.unassignedSlots.filter(s => s.mName === mName)[slotIdx];
            slot.fixedName = bestCandidate.name; slot.type = bestCandidate.type;
            dd.pool[bestCandidate.type]--; dd.poolNames[bestCandidate.type].splice(dd.poolNames[bestCandidate.type].indexOf(bestCandidate.name), 1);
          });
        }
      }
    }
    
    let simResultMaps = [];
    let isValidRoute = true;
    simDecks.forEach((dd) => {
      let res = dfsBestScore(dd.pairs, dd.pool);
      if(res.score === Infinity) { isValidRoute = false; return; }
      let resMap = {};
      for(let j=0; j<dd.pairs.length; j++) {
        let p1 = dd.pairs[j][0], p2 = dd.pairs[j][1]; let t1 = res.assignment[j][0], t2 = res.assignment[j][1];
        if(!resMap[p1.mName]) resMap[p1.mName] = []; resMap[p1.mName][p1.idx] = p1.fixedName ? p1.fixedName : dd.poolNames[t1].pop();
        if(p2) { if(!resMap[p2.mName]) resMap[p2.mName] = []; resMap[p2.mName][p2.idx] = p2.fixedName ? p2.fixedName : dd.poolNames[t2].pop(); }
      }
      simResultMaps.push(resMap);
    });
    if(!isValidRoute) continue;
    
    let globalNeeds = {};
    simResultMaps.forEach(resMap => {
      for(let m in resMap) {
        if(!globalNeeds[m]) globalNeeds[m] = {}; let localCounts = {};
        resMap[m].forEach(c => localCounts[c] = (localCounts[c]||0)+1);
        for(let c in localCounts) globalNeeds[m][c] = Math.max(globalNeeds[m][c] || 0, localCounts[c]);
      }
    });
    
    let currentCost = 0;
    for(let m in globalNeeds) {
      let weight = getWeight(m);
      let count = Object.values(globalNeeds[m]).reduce((a,b)=>a+b,0);
      currentCost += weight * count; 
    }
    
    if(currentCost < bestGlobalCost) { bestGlobalCost = currentCost; bestResultMaps = simResultMaps; }
  }

  if(!bestResultMaps) {
    output.innerHTML = '<span style="color:red; font-weight:bold;">æœ€é©åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ï¼ˆã‚¨ãƒ©ãƒ¼ç™ºç”Ÿï¼‰</span>'; return;
  }

  savedDecks.forEach((d, i) => { d.state.optimizedResult = bestResultMaps[i]; });
  localStorage.setItem('dq10_v54_decks', JSON.stringify(savedDecks)); renderDeckList();

  let finalGlobalNeeds = {};
  savedDecks.forEach(d => {
    for(let mName in d.state.optimizedResult) {
      if(!finalGlobalNeeds[mName]) finalGlobalNeeds[mName] = {}; let localCounts = {};
      d.state.optimizedResult[mName].forEach(c => localCounts[c] = (localCounts[c]||0)+1);
      for(let c in localCounts) finalGlobalNeeds[mName][c] = Math.max(finalGlobalNeeds[mName][c] || 0, localCounts[c]);
    }
  });
  
  renderCardList(finalGlobalNeeds, output, "ğŸ´ æœ€é©åŒ–å®Œäº†: å¿…è¦ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ");
}

function renderCardList(needsMap, container, title) {
  let html = `<div style="background:#fff; border:2px solid #ddd; border-radius:6px; padding:15px;"><h3 style="margin-top:0; color:#2E7D32;">${title}</h3>`;
  const finalSorted = Object.keys(needsMap).sort((a,b) => getWeight(b) - getWeight(a));
  
  const arcanaOrder = {};
  ARCANA_DATA.forEach((a, idx) => { arcanaOrder[a.name] = idx; });

  finalSorted.forEach(m => {
    let cardsHtml = ''; 
    let sortedArcanas = Object.keys(needsMap[m]).sort((a, b) => arcanaOrder[a] - arcanaOrder[b]);
    for(let c of sortedArcanas) {
      cardsHtml += `<span class="res-card" style="background:${getArcanaColor(c)}; font-size:12px;">${c} x${needsMap[m][c]}</span>`;
    }
    html += `<div class="opt-res-row"><div class="opt-res-mon">${m}</div><div>${cardsHtml}</div></div>`;
  }); 
  html += '</div>'; container.innerHTML = html;
}

// ================= EXPORT / IMPORT =================
function exportData() {
  const data = { state: appState, decks: savedDecks };
  try {
    const shortObj = { 
      s: { a: data.state.arcanaCounts, p: data.state.arcanaPriorities, m: data.state.monsterCounts, e: data.state.exceptionData }, 
      d: data.decks.map(d => ({ n: d.name, a: d.state.arcanaCounts, p: d.state.arcanaPriorities, m: d.state.monsterCounts, e: d.state.exceptionData, o: d.state.optimizedResult })) 
    };
    const compressed = btoa(unescape(encodeURIComponent(JSON.stringify(shortObj))));
    document.getElementById('io-data').value = compressed;
    alert("ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã—ã¾ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
  } catch(e) { alert("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
}

function importData() {
  const text = document.getElementById('io-data').value.trim();
  if(!text) { alert("ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"); return; }
  try {
    let parsed;
    if(text.startsWith('{')) {
      parsed = JSON.parse(text);
      if(parsed.state && parsed.decks) { appState = parsed.state; savedDecks = parsed.decks; } else throw new Error();
    } else {
      const shortObj = JSON.parse(decodeURIComponent(escape(atob(text))));
      appState = { arcanaCounts: shortObj.s.a||{}, arcanaPriorities: shortObj.s.p||{}, monsterCounts: shortObj.s.m||{}, exceptionData: shortObj.s.e||{}, optimizedResult: {} };
      savedDecks = shortObj.d.map(d => ({ name: d.n, state: { arcanaCounts: d.a||{}, arcanaPriorities: d.p||{}, monsterCounts: d.m||{}, exceptionData: d.e||{}, optimizedResult: d.o||{} } }));
    }
    if(!confirm("ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ã™ã¹ã¦ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    saveData(); localStorage.setItem('dq10_v54_decks', JSON.stringify(savedDecks)); renderAll();
    alert("ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸã€‚");
  } catch(e) { alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: æ­£ã—ã„ãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"); }
}

// ================= STORAGE =================
function renderDeckList() {
  const c = document.getElementById('deck-list-container'); c.innerHTML = '';
  savedDecks.forEach((d, i) => {
    const item = document.createElement('div'); item.className = 'deck-item'; let contentHtml = '';
    if(d.state.optimizedResult && Object.keys(d.state.optimizedResult).length > 0) {
      for(let m in d.state.optimizedResult) {
        let cards = d.state.optimizedResult[m].map(name => `<span class="res-card res-${d.state.arcanaPriorities[name]||'N'}" style="font-weight:normal;">${name}</span>`).join('');
        contentHtml += `<div class="opt-res-row"><div class="opt-res-mon">${m}</div><div>${cards}</div></div>`;
      }
    } else contentHtml = '<span style="color:#999; font-weight:bold;">æ§‹æˆãŒã¾ã ä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</span>';
    item.innerHTML = `<div class="deck-header" onclick="toggleDeck(${i})"><span class="deck-name">${d.name}</span>
      <div><button onclick="event.stopPropagation(); loadDeck(${i})" style="padding:6px 10px; cursor:pointer; background:#e3f2fd; border:1px solid #90caf9; border-radius:4px; font-weight:bold; color:#1565c0;">èª­è¾¼</button>
      <button onclick="event.stopPropagation(); deleteDeck(${i})" style="padding:6px 10px; background:#c62828; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:bold; margin-left:4px;">å‰Šé™¤</button></div></div>
      <div id="deck-body-${i}" class="deck-body">${contentHtml}</div>`; c.appendChild(item);
  });
}
function toggleDeck(i) { document.getElementById(`deck-body-${i}`).classList.toggle('open'); }
function saveCurrentDeck() {
  const name = document.getElementById('deck-name-input').value || `ãƒã‚¤ãƒ‡ãƒƒã‚­ ${savedDecks.length+1}`;
  savedDecks.push({ name: name, state: JSON.parse(JSON.stringify(appState)) }); localStorage.setItem('dq10_v54_decks', JSON.stringify(savedDecks)); renderDeckList(); document.getElementById('deck-name-input').value = '';
}
function loadDeck(i) { if(!confirm(`ã€Œ${savedDecks[i].name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ`)) return; appState = JSON.parse(JSON.stringify(savedDecks[i].state)); saveData(); renderAll(); switchTab('arcana'); }
function deleteDeck(i) { if(!confirm(`å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return; savedDecks.splice(i, 1); localStorage.setItem('dq10_v54_decks', JSON.stringify(savedDecks)); renderDeckList(); }
function switchTab(id) { 
  activeTabId = id;
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active')); 
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
  document.getElementById('panel-' + id).classList.add('active'); 
  document.querySelector(`button[onclick="switchTab('${id}')"]`).classList.add('active'); 
  if(id === 'exception') renderException(); 
  if(id === 'storage') renderDeckList(); 
  updateStats();
}
</script>
</body>

</html>

